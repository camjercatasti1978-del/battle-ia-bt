<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¨ AI Trading Bot - DONN√âES TRADINGVIEW</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            min-height: 100vh;
            color: white;
        }
        .ai-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }
        .ai-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        .ai-card.active {
            border: 3px solid #10b981;
            box-shadow: 0 0 25px rgba(16, 185, 129, 0.5);
        }
        .trade-log {
            max-height: 400px;
            overflow-y: auto;
        }
        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse {
            animation: pulse 2s ease-in-out infinite;
        }
    </style>
</head>
<body class="p-4 md:p-6">
    <div class="max-w-7xl mx-auto">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent mb-3">
                üî¨ AI Trading Bot - TRADINGVIEW
            </h1>
            <p class="text-gray-300 text-lg">Backtesting avec donn√©es historiques R√âELLES de TradingView</p>
            <div class="mt-3 flex justify-center gap-4 items-center flex-wrap">
                <span class="px-4 py-2 bg-blue-900 bg-opacity-50 text-blue-300 rounded-full font-semibold text-sm border border-blue-500">üìä TradingView Data</span>
                <span class="px-4 py-2 bg-green-900 bg-opacity-50 text-green-300 rounded-full font-semibold text-sm border border-green-500">‚úÖ Prix R√©els</span>
                <span class="px-4 py-2 bg-purple-900 bg-opacity-50 text-purple-300 rounded-full font-semibold text-sm border border-purple-500">üî¨ Multi-Exchange</span>
            </div>
        </div>

        <!-- Configuration -->
        <div class="card p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">‚öôÔ∏è Configuration</h2>

            <div class="bg-green-900 bg-opacity-50 border-2 border-green-500 rounded-lg p-4 mb-4">
                <p class="text-green-200 font-bold mb-2">‚úÖ SOURCE : YAHOO FINANCE API (via TradingView format)</p>
                <ul class="text-sm text-green-200 space-y-1">
                    <li>‚Ä¢ Prix historiques R√âELS OHLCV</li>
                    <li>‚Ä¢ API gratuite sans limite</li>
                    <li>‚Ä¢ Donn√©es des plus grandes exchanges</li>
                    <li>‚Ä¢ Format compatible TradingView</li>
                </ul>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm text-gray-300 mb-2 font-semibold">Exchange</label>
                    <select id="exchangeSelect" onchange="updateSymbols()" class="w-full bg-gray-800 border-2 border-gray-600 rounded-lg px-4 py-3 text-white">
                        <option value="crypto">Crypto (Yahoo Finance)</option>
                        <option value="binance">Binance</option>
                        <option value="stocks">Actions US</option>
                        <option value="forex">Forex</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm text-gray-300 mb-2 font-semibold">Symbole</label>
                    <select id="symbolSelect" class="w-full bg-gray-800 border-2 border-gray-600 rounded-lg px-4 py-3 text-white">
                        <option value="BTC-USD">Bitcoin (BTC-USD)</option>
                        <option value="ETH-USD">Ethereum (ETH-USD)</option>
                        <option value="BNB-USD">Binance Coin (BNB-USD)</option>
                        <option value="ADA-USD">Cardano (ADA-USD)</option>
                        <option value="SOL-USD">Solana (SOL-USD)</option>
                        <option value="XRP-USD">Ripple (XRP-USD)</option>
                        <option value="DOT-USD">Polkadot (DOT-USD)</option>
                        <option value="DOGE-USD">Dogecoin (DOGE-USD)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm text-gray-300 mb-2 font-semibold">P√©riode</label>
                    <select id="periodSelect" class="w-full bg-gray-800 border-2 border-gray-600 rounded-lg px-4 py-3 text-white">
                        <option value="1d">1 jour</option>
                        <option value="5d" selected>5 jours</option>
                        <option value="1mo">1 mois</option>
                        <option value="3mo">3 mois</option>
                        <option value="6mo">6 mois</option>
                        <option value="1y">1 an</option>
                        <option value="2y">2 ans</option>
                        <option value="5y">5 ans</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm text-gray-300 mb-2 font-semibold">Intervalle</label>
                    <select id="intervalSelect" class="w-full bg-gray-800 border-2 border-gray-600 rounded-lg px-4 py-3 text-white">
                        <option value="1m">1 minute</option>
                        <option value="5m">5 minutes</option>
                        <option value="15m">15 minutes</option>
                        <option value="1h" selected>1 heure</option>
                        <option value="1d">1 jour</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm text-gray-300 mb-2 font-semibold">Capital initial (USD)</label>
                    <input type="number" id="initialCapital" value="10000" min="100" step="100" class="w-full bg-gray-800 border-2 border-gray-600 rounded-lg px-4 py-3 text-white">
                </div>

                <div>
                    <label class="block text-sm text-gray-300 mb-2 font-semibold">Frais (%)</label>
                    <input type="number" id="feesInput" value="0.1" min="0" max="1" step="0.05" class="w-full bg-gray-800 border-2 border-gray-600 rounded-lg px-4 py-3 text-white">
                </div>
            </div>

            <button onclick="loadTradingViewData()" id="loadBtn" class="w-full px-6 py-4 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white rounded-lg font-bold text-lg mb-4">
                üì• Charger Donn√©es R√©elles
            </button>

            <div id="loadingStatus" class="text-center text-gray-400 py-4" style="display: none;">
                <div class="pulse text-blue-400 font-bold">‚è≥ Chargement des donn√©es...</div>
            </div>

            <div id="dataStatus" class="grid grid-cols-2 md:grid-cols-4 gap-3" style="display: none;">
                <div class="bg-blue-900 bg-opacity-30 border border-blue-600 rounded-lg p-3">
                    <p class="text-xs text-gray-400">Chandeliers</p>
                    <p class="font-bold text-blue-400" id="dataPoints">0</p>
                </div>
                <div class="bg-green-900 bg-opacity-30 border border-green-600 rounded-lg p-3">
                    <p class="text-xs text-gray-400">P√©riode</p>
                    <p class="font-bold text-green-400 text-xs" id="dataPeriod">-</p>
                </div>
                <div class="bg-yellow-900 bg-opacity-30 border border-yellow-600 rounded-lg p-3">
                    <p class="text-xs text-gray-400">Prix min</p>
                    <p class="font-bold text-yellow-400" id="dataMin">$0</p>
                </div>
                <div class="bg-purple-900 bg-opacity-30 border border-purple-600 rounded-lg p-3">
                    <p class="text-xs text-gray-400">Prix max</p>
                    <p class="font-bold text-purple-400" id="dataMax">$0</p>
                </div>
            </div>
        </div>

        <!-- IA Selection -->
        <div class="card p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">ü§ñ S√©lection des IA</h2>
            
            <div class="bg-blue-900 bg-opacity-50 border-2 border-blue-500 rounded-lg p-4 mb-4">
                <p class="text-blue-200 font-bold mb-2">‚ÑπÔ∏è STRAT√âGIES</p>
                <ul class="text-sm text-blue-200 space-y-1">
                    <li>‚Ä¢ <strong>üß† Claude:</strong> Conservateur - RSI < 30, TP +2%, SL -1%</li>
                    <li>‚Ä¢ <strong>üíé Gemini:</strong> √âquilibr√© - RSI < 35, TP +3%, SL -1.5%</li>
                    <li>‚Ä¢ <strong>üöÄ ChatGPT:</strong> Momentum - EMA cross, TP +4%, SL -2%</li>
                    <li>‚Ä¢ <strong>‚ö° Grok:</strong> Agressif - Momentum > 2%, TP +5%, SL -2.5%</li>
                </ul>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4" id="aiCards"></div>

            <button onclick="startBacktest()" id="startBtn" class="w-full px-6 py-4 bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600 text-white rounded-lg font-bold text-lg" disabled>
                üöÄ Lancer Backtest
            </button>
        </div>

        <!-- Progress -->
        <div class="card p-6 mb-6" id="progressSection" style="display: none;">
            <h2 class="text-2xl font-bold mb-4">‚è±Ô∏è Progression</h2>
            
            <div class="mb-4">
                <div class="flex justify-between mb-2">
                    <span class="text-gray-400">Progression</span>
                    <span class="font-bold text-green-400" id="progressPercent">0%</span>
                </div>
                <div class="w-full bg-gray-800 rounded-full h-4">
                    <div id="progressBar" class="bg-gradient-to-r from-green-500 to-teal-500 h-4 rounded-full transition-all" style="width: 0%"></div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="bg-gray-800 border border-gray-600 rounded-lg p-3">
                    <p class="text-xs text-gray-400">Point</p>
                    <p class="font-bold text-white" id="currentPoint">0 / 0</p>
                </div>
                <div class="bg-blue-900 bg-opacity-30 border border-blue-600 rounded-lg p-3">
                    <p class="text-xs text-gray-400">Date</p>
                    <p class="font-bold text-blue-400 text-xs" id="currentTime">-</p>
                </div>
                <div class="bg-green-900 bg-opacity-30 border border-green-600 rounded-lg p-3">
                    <p class="text-xs text-gray-400">Prix</p>
                    <p class="font-bold text-green-400" id="currentPrice">$0</p>
                </div>
                <div class="bg-purple-900 bg-opacity-30 border border-purple-600 rounded-lg p-3">
                    <p class="text-xs text-gray-400">Trades</p>
                    <p class="font-bold text-purple-400" id="totalTrades">0</p>
                </div>
            </div>
        </div>

        <!-- Chart & Leaderboard -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <div class="lg:col-span-2 card p-6">
                <h2 class="text-2xl font-bold mb-4">üìà Prix Historiques</h2>
                <div class="h-80">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>

            <div class="card p-6">
                <h2 class="text-2xl font-bold mb-4">üèÜ Classement</h2>
                <div id="leaderboard" class="space-y-3">
                    <div class="bg-gray-800 bg-opacity-50 rounded-lg p-4">
                        <p class="text-center text-gray-400">Chargez des donn√©es</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="card p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">üìä Statistiques D√©taill√©es</h2>
            <div id="detailedStats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-gray-800 bg-opacity-50 rounded-lg p-4">
                    <p class="text-center text-gray-400">Pas de stats</p>
                </div>
            </div>
        </div>

        <!-- Logs -->
        <div class="card p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">üìã Journal</h2>
                <button onclick="clearLogs()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg text-sm">
                    üóëÔ∏è Effacer
                </button>
            </div>
            <div id="tradeLogs" class="trade-log space-y-2">
                <div class="text-center text-gray-500 py-8">Chargez des donn√©es...</div>
            </div>
        </div>
    </div>

    <script>
        const SYMBOL_PRESETS = {
            crypto: [
                { value: 'BTC-USD', label: 'Bitcoin (BTC-USD)' },
                { value: 'ETH-USD', label: 'Ethereum (ETH-USD)' },
                { value: 'BNB-USD', label: 'Binance Coin (BNB-USD)' },
                { value: 'ADA-USD', label: 'Cardano (ADA-USD)' },
                { value: 'SOL-USD', label: 'Solana (SOL-USD)' },
                { value: 'XRP-USD', label: 'Ripple (XRP-USD)' },
                { value: 'DOT-USD', label: 'Polkadot (DOT-USD)' },
                { value: 'DOGE-USD', label: 'Dogecoin (DOGE-USD)' }
            ],
            binance: [
                { value: 'BTCUSDT', label: 'BTC/USDT (Binance)' },
                { value: 'ETHUSDT', label: 'ETH/USDT (Binance)' },
                { value: 'BNBUSDT', label: 'BNB/USDT (Binance)' },
                { value: 'ADAUSDT', label: 'ADA/USDT (Binance)' }
            ],
            stocks: [
                { value: 'AAPL', label: 'Apple (AAPL)' },
                { value: 'MSFT', label: 'Microsoft (MSFT)' },
                { value: 'GOOGL', label: 'Google (GOOGL)' },
                { value: 'TSLA', label: 'Tesla (TSLA)' },
                { value: 'NVDA', label: 'Nvidia (NVDA)' }
            ],
            forex: [
                { value: 'EURUSD=X', label: 'EUR/USD' },
                { value: 'GBPUSD=X', label: 'GBP/USD' },
                { value: 'USDJPY=X', label: 'USD/JPY' }
            ]
        };

        let state = {
            historicalData: [],
            selectedSymbol: 'BTC-USD',
            selectedPeriod: '5d',
            selectedInterval: '1h',
            exchange: 'crypto',
            initialCapital: 10000,
            fees: 0.1,
            activeAIs: { claude: false, gemini: false, chatgpt: false, grok: false },
            aiStats: {
                claude: { trades: 0, profit: 0, wins: 0, losses: 0, capital: 0, trades_detail: [] },
                gemini: { trades: 0, profit: 0, wins: 0, losses: 0, capital: 0, trades_detail: [] },
                chatgpt: { trades: 0, profit: 0, wins: 0, losses: 0, capital: 0, trades_detail: [] },
                grok: { trades: 0, profit: 0, wins: 0, losses: 0, capital: 0, trades_detail: [] }
            },
            positions: { claude: null, gemini: null, chatgpt: null, grok: null },
            tradeLogs: [],
            currentIndex: 0
        };

        let priceChart = null;

        window.addEventListener('DOMContentLoaded', () => {
            console.log('üî¨ TRADINGVIEW DATA BACKTEST');
            initChart();
            renderAICards();
        });

        function updateSymbols() {
            const exchange = document.getElementById('exchangeSelect').value;
            state.exchange = exchange;
            
            const symbolSelect = document.getElementById('symbolSelect');
            const symbols = SYMBOL_PRESETS[exchange];
            
            symbolSelect.innerHTML = symbols.map(s => 
                `<option value="${s.value}">${s.label}</option>`
            ).join('');
        }

        function initChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Prix',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        x: { 
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }, 
                            ticks: { color: 'white', maxTicksLimit: 10 } 
                        },
                        y: { 
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }, 
                            ticks: { color: 'white' } 
                        }
                    }
                }
            });
        }

        function renderAICards() {
            const ais = [
                { id: 'claude', icon: 'üß†', name: 'Claude' },
                { id: 'gemini', icon: 'üíé', name: 'Gemini' },
                { id: 'chatgpt', icon: 'üöÄ', name: 'ChatGPT' },
                { id: 'grok', icon: '‚ö°', name: 'Grok' }
            ];

            document.getElementById('aiCards').innerHTML = ais.map(ai => `
                <div class="ai-card rounded-xl p-5" id="card-${ai.id}">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <span class="text-3xl">${ai.icon}</span>
                            <h3 class="text-xl font-bold">${ai.name}</h3>
                        </div>
                        <input type="checkbox" id="ai-${ai.id}" onclick="toggleAI('${ai.id}')" class="w-5 h-5 cursor-pointer">
                    </div>
                    <div class="space-y-2 text-xs">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Trades:</span>
                            <span id="${ai.id}-trades" class="font-bold text-green-400">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Profit:</span>
                            <span id="${ai.id}-profit" class="font-bold text-green-400">$0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Win Rate:</span>
                            <span id="${ai.id}-winrate" class="font-bold">0%</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function toggleAI(aiName) {
            state.activeAIs[aiName] = !state.activeAIs[aiName];
            const card = document.getElementById(`card-${aiName}`);
            const checkbox = document.getElementById(`ai-${aiName}`);
            
            if (state.activeAIs[aiName]) {
                card.classList.add('active');
                checkbox.checked = true;
            } else {
                card.classList.remove('active');
                checkbox.checked = false;
            }
        }

        // YAHOO FINANCE API (format TradingView compatible)
        async function loadTradingViewData() {
            const symbol = document.getElementById('symbolSelect').value;
            const period = document.getElementById('periodSelect').value;
            const interval = document.getElementById('intervalSelect').value;
            
            state.selectedSymbol = symbol;
            state.selectedPeriod = period;
            state.selectedInterval = interval;
            state.initialCapital = parseFloat(document.getElementById('initialCapital').value);
            state.fees = parseFloat(document.getElementById('feesInput').value);
            
            document.getElementById('loadingStatus').style.display = 'block';
            document.getElementById('dataStatus').style.display = 'none';
            document.getElementById('loadBtn').disabled = true;
            
            try {
                let data;
                
                // Use Binance for binance exchange
                if (state.exchange === 'binance') {
                    const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=1000`;
                    addLog('system', 'üì• BINANCE', `Chargement ${symbol}...`);
                    
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Binance Error: ${response.status}`);
                    
                    const binanceData = await response.json();
                    data = binanceData.map(candle => ({
                        timestamp: candle[0],
                        time: new Date(candle[0]).toLocaleString('fr-FR'),
                        open: parseFloat(candle[1]),
                        high: parseFloat(candle[2]),
                        low: parseFloat(candle[3]),
                        close: parseFloat(candle[4]),
                        volume: parseFloat(candle[5])
                    }));
                } else {
                    // Use Yahoo Finance for other markets
                    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=${period}&interval=${interval}`;
                    
                    addLog('system', 'üì• YAHOO FINANCE', `Chargement ${symbol}...`);
                    console.log('Fetching:', url);
                    
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Yahoo Error: ${response.status}`);
                    
                    const yahooData = await response.json();
                    const result = yahooData.chart.result[0];
                    const timestamps = result.timestamp;
                    const quotes = result.indicators.quote[0];
                    
                    data = timestamps.map((ts, i) => ({
                        timestamp: ts * 1000,
                        time: new Date(ts * 1000).toLocaleString('fr-FR'),
                        open: quotes.open[i] || 0,
                        high: quotes.high[i] || 0,
                        low: quotes.low[i] || 0,
                        close: quotes.close[i] || 0,
                        volume: quotes.volume[i] || 0
                    })).filter(d => d.close > 0);
                }
                
                state.historicalData = data;
                
                const prices = state.historicalData.map(d => d.close);
                const minPrice = Math.min(...prices);
                const maxPrice = Math.max(...prices);
                
                const startDate = new Date(state.historicalData[0].timestamp).toLocaleDateString('fr-FR');
                const endDate = new Date(state.historicalData[state.historicalData.length - 1].timestamp).toLocaleDateString('fr-FR');
                
                document.getElementById('dataPoints').textContent = state.historicalData.length;
                document.getElementById('dataPeriod').textContent = `${startDate} ‚Üí ${endDate}`;
                document.getElementById('dataMin').textContent = '$' + minPrice.toFixed(2);
                document.getElementById('dataMax').textContent = '$' + maxPrice.toFixed(2);
                
                document.getElementById('loadingStatus').style.display = 'none';
                document.getElementById('dataStatus').style.display = 'grid';
                document.getElementById('startBtn').disabled = false;
                
                updateChart();
                
                addLog('system', '‚úÖ DONN√âES CHARG√âES', `${state.historicalData.length} chandeliers R√âELS (${symbol})`);
                console.log('‚úÖ Loaded', state.historicalData.length, 'candles');
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                addLog('system', '‚ùå ERREUR', error.message);
                alert('‚ùå Erreur: ' + error.message);
                
                document.getElementById('loadingStatus').style.display = 'none';
                document.getElementById('loadBtn').disabled = false;
            }
        }

        function updateChart() {
            if (!priceChart || !state.historicalData.length) return;
            
            const step = Math.max(1, Math.floor(state.historicalData.length / 200));
            const filtered = state.historicalData.filter((_, i) => i % step === 0);
            
            priceChart.data.labels = filtered.map(d => new Date(d.timestamp).toLocaleDateString('fr-FR', {
                month: 'short',
                day: 'numeric',
                hour: state.selectedInterval.includes('m') || state.selectedInterval === '1h' ? '2-digit' : undefined
            }));
            priceChart.data.datasets[0].data = filtered.map(d => d.close);
            priceChart.update();
        }

        // BACKTEST (same logic as before)
        async function startBacktest() {
            const activeCount = Object.values(state.activeAIs).filter(v => v).length;
            
            if (activeCount === 0) {
                alert('‚ùå S√©lectionnez au moins une IA');
                return;
            }
            
            if (!state.historicalData.length) {
                alert('‚ùå Chargez d\'abord les donn√©es');
                return;
            }
            
            for (const ai in state.aiStats) {
                state.aiStats[ai] = { 
                    trades: 0, profit: 0, wins: 0, losses: 0, 
                    capital: state.initialCapital, trades_detail: []
                };
            }
            state.positions = { claude: null, gemini: null, chatgpt: null, grok: null };
            state.tradeLogs = [];
            
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('startBtn').disabled = true;
            document.getElementById('loadBtn').disabled = true;
            
            addLog('system', 'üî¨ START', `Backtest ${activeCount} IA ‚Ä¢ ${state.historicalData.length} chandeliers`);
            
            await runBacktest();
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('loadBtn').disabled = false;
            
            updateLeaderboard();
            displayDetailedStats();
            addLog('system', '‚úÖ TERMIN√â', 'Backtest compl√©t√©');
        }

        async function runBacktest() {
            const total = state.historicalData.length;
            const minPeriod = 50;
            
            for (let i = minPeriod; i < total; i++) {
                state.currentIndex = i;
                
                const slice = state.historicalData.slice(0, i + 1);
                const current = state.historicalData[i];
                
                const progress = ((i - minPeriod) / (total - minPeriod)) * 100;
                document.getElementById('progressBar').style.width = progress.toFixed(1) + '%';
                document.getElementById('progressPercent').textContent = progress.toFixed(1) + '%';
                document.getElementById('currentPoint').textContent = `${i + 1} / ${total}`;
                document.getElementById('currentTime').textContent = new Date(current.timestamp).toLocaleString('fr-FR');
                document.getElementById('currentPrice').textContent = '$' + current.close.toFixed(2);
                
                let totalTrades = 0;
                for (const ai in state.aiStats) totalTrades += state.aiStats[ai].trades;
                document.getElementById('totalTrades').textContent = totalTrades;
                
                for (const [aiName, isActive] of Object.entries(state.activeAIs)) {
                    if (!isActive) continue;
                    analyzeAndTrade(aiName, slice, current);
                }
                
                if (i % 10 === 0) await new Promise(r => setTimeout(r, 1));
            }
            
            for (const [aiName, isActive] of Object.entries(state.activeAIs)) {
                if (!isActive) continue;
                if (state.positions[aiName]) {
                    executeSell(aiName, state.historicalData[total - 1]);
                }
            }
        }

        function analyzeAndTrade(aiName, slice, current) {
            const prices = slice.map(d => d.close);
            const price = current.close;
            
            if (!state.positions[aiName] && shouldBuy(aiName, prices, price)) {
                executeBuy(aiName, current);
            } else if (state.positions[aiName] && shouldSell(aiName, state.positions[aiName], current)) {
                executeSell(aiName, current);
            }
        }

        function calculateRSI(prices, period = 14) {
            if (prices.length < period + 1) return 50;
            let gains = 0, losses = 0;
            for (let i = prices.length - period; i < prices.length; i++) {
                const change = prices[i] - prices[i - 1];
                if (change > 0) gains += change;
                else losses += Math.abs(change);
            }
            const avgGain = gains / period;
            const avgLoss = losses / period;
            if (avgLoss === 0) return 100;
            return 100 - (100 / (1 + (avgGain / avgLoss)));
        }

        function calculateEMA(prices, period) {
            if (prices.length < period) return prices[prices.length - 1];
            const k = 2 / (period + 1);
            let ema = prices[0];
            for (let i = 1; i < prices.length; i++) {
                ema = prices[i] * k + ema * (1 - k);
            }
            return ema;
        }

        function calculateMomentum(prices, period = 10) {
            if (prices.length < period) return 0;
            return (prices[prices.length - 1] - prices[prices.length - period]) / prices[prices.length - period];
        }

        function shouldBuy(aiName, prices, price) {
            if (prices.length < 50) return false;
            const rsi = calculateRSI(prices);
            const ema20 = calculateEMA(prices, 20);
            const ema50 = calculateEMA(prices, 50);
            const momentum = calculateMomentum(prices);
            
            switch(aiName) {
                case 'claude': return rsi < 30 && ema20 > ema50 && price > ema20;
                case 'gemini': return rsi < 35 && momentum > 0.01 && price > ema20;
                case 'chatgpt': return ema20 > ema50 && momentum > 0.015 && rsi < 70;
                case 'grok': return momentum > 0.02 && rsi < 60;
                default: return false;
            }
        }

        function shouldSell(aiName, position, current) {
            if (!position) return false;
            const profitPercent = ((current.close - position.entryPrice) / position.entryPrice) * 100;
            const strategies = {
                claude: { tp: 2, sl: -1 },
                gemini: { tp: 3, sl: -1.5 },
                chatgpt: { tp: 4, sl: -2 },
                grok: { tp: 5, sl: -2.5 }
            };
            const s = strategies[aiName];
            return profitPercent >= s.tp || profitPercent <= s.sl;
        }

        function executeBuy(aiName, current) {
            const stats = state.aiStats[aiName];
            const tradeAmount = stats.capital * 0.3;
            if (tradeAmount < 10) return;
            
            const fees = tradeAmount * (state.fees / 100);
            const totalCost = tradeAmount + fees;
            if (totalCost > stats.capital) return;
            
            const tokensAmount = tradeAmount / current.close;
            state.positions[aiName] = {
                entryPrice: current.close,
                amount: tradeAmount,
                tokensAmount: tokensAmount,
                entryTime: current.timestamp
            };
            
            stats.capital -= totalCost;
            stats.trades++;
            addLog(aiName, 'üü¢ BUY', `${tokensAmount.toFixed(6)} @ $${current.close.toFixed(2)}`);
        }

        function executeSell(aiName, current) {
            const position = state.positions[aiName];
            if (!position) return;
            
            const stats = state.aiStats[aiName];
            const sellValue = position.tokensAmount * current.close;
            const fees = sellValue * (state.fees / 100);
            const netValue = sellValue - fees;
            const profit = netValue - position.amount;
            const profitPercent = (profit / position.amount) * 100;
            
            stats.capital += netValue;
            stats.profit += profit;
            if (profit > 0) stats.wins++; else stats.losses++;
            stats.trades_detail.push({ profit, profitPercent });
            
            addLog(aiName, profit >= 0 ? 'üü¢ SELL' : 'üî¥ SELL', 
                `$${netValue.toFixed(2)} ‚Ä¢ ${profit >= 0 ? '+' : ''}$${profit.toFixed(2)} (${profitPercent >= 0 ? '+' : ''}${profitPercent.toFixed(2)}%)`);
            
            state.positions[aiName] = null;
            updateAIStats(aiName);
        }

        function updateAIStats(aiName) {
            const stats = state.aiStats[aiName];
            const totalProfit = stats.capital - state.initialCapital;
            const winRate = stats.trades > 0 ? ((stats.wins / stats.trades) * 100).toFixed(1) : 0;
            
            document.getElementById(`${aiName}-trades`).textContent = stats.trades;
            document.getElementById(`${aiName}-profit`).textContent = 
                (totalProfit >= 0 ? '+$' : '-$') + Math.abs(totalProfit).toFixed(2);
            document.getElementById(`${aiName}-winrate`).textContent = winRate + '%';
            
            const el = document.getElementById(`${aiName}-profit`);
            el.className = totalProfit >= 0 ? 'font-bold text-green-400' : 'font-bold text-red-400';
        }

        function updateLeaderboard() {
            const sorted = Object.entries(state.aiStats)
                .filter(([name]) => state.activeAIs[name])
                .map(([name, stats]) => ({
                    name, stats,
                    totalProfit: stats.capital - state.initialCapital,
                    roi: ((stats.capital - state.initialCapital) / state.initialCapital) * 100
                }))
                .sort((a, b) => b.totalProfit - a.totalProfit);
            
            const icons = { claude: 'üß†', gemini: 'üíé', chatgpt: 'üöÄ', grok: '‚ö°' };
            
            const html = sorted.map((item, i) => {
                const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : 'üîπ';
                const wr = item.stats.trades > 0 ? ((item.stats.wins / item.stats.trades) * 100).toFixed(1) : 0;
                
                return `
                    <div class="bg-gray-800 bg-opacity-50 border border-gray-600 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">${medal}</span>
                                <span class="text-xl">${icons[item.name]}</span>
                                <span class="font-bold">${item.name.toUpperCase()}</span>
                            </div>
                            <span class="text-xl font-bold ${item.totalProfit >= 0 ? 'text-green-400' : 'text-red-400'}">
                                ${item.totalProfit >= 0 ? '+' : ''}$${item.totalProfit.toFixed(2)}
                            </span>
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-xs text-gray-400">
                            <div>Trades: <span class="text-white font-bold">${item.stats.trades}</span></div>
                            <div>WR: <span class="font-bold">${wr}%</span></div>
                            <div>ROI: <span class="font-bold ${item.roi >= 0 ? 'text-green-400' : 'text-red-400'}">${item.roi >= 0 ? '+' : ''}${item.roi.toFixed(1)}%</span></div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('leaderboard').innerHTML = html || '<div class="text-center text-gray-500 py-8">Pas d\'IA active</div>';
        }

        function displayDetailedStats() {
            const activeAIs = Object.entries(state.aiStats).filter(([name]) => state.activeAIs[name]);
            const icons = { claude: 'üß†', gemini: 'üíé', chatgpt: 'üöÄ', grok: '‚ö°' };
            
            const html = activeAIs.map(([name, stats]) => {
                const totalProfit = stats.capital - state.initialCapital;
                const roi = ((stats.capital - state.initialCapital) / state.initialCapital) * 100;
                const wr = stats.trades > 0 ? ((stats.wins / stats.trades) * 100).toFixed(1) : 0;
                const avgWin = stats.wins > 0 ? (stats.trades_detail.filter(t => t.profit > 0).reduce((s, t) => s + t.profit, 0) / stats.wins) : 0;
                const avgLoss = stats.losses > 0 ? (stats.trades_detail.filter(t => t.profit < 0).reduce((s, t) => s + t.profit, 0) / stats.losses) : 0;
                
                return `
                    <div class="bg-gray-800 bg-opacity-50 border border-gray-600 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-2xl">${icons[name]}</span>
                            <h3 class="font-bold text-lg">${name.toUpperCase()}</h3>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">ROI:</span>
                                <span class="font-bold ${roi >= 0 ? 'text-green-400' : 'text-red-400'}">${roi >= 0 ? '+' : ''}${roi.toFixed(2)}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Profit:</span>
                                <span class="font-bold ${totalProfit >= 0 ? 'text-green-400' : 'text-red-400'}">${totalProfit >= 0 ? '+' : ''}$${totalProfit.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Win rate:</span>
                                <span class="font-bold text-white">${wr}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Avg win:</span>
                                <span class="font-bold text-green-400">+$${avgWin.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Avg loss:</span>
                                <span class="font-bold text-red-400">$${avgLoss.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Capital:</span>
                                <span class="font-bold text-white">${stats.capital.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('detailedStats').innerHTML = html || 
                '<div class="col-span-4 text-center text-gray-500 py-8">Pas de stats</div>';
        }

        function addLog(source, action, details) {
            const timestamp = new Date().toLocaleTimeString();
            state.tradeLogs.unshift({ timestamp, source, action, details });
            if (state.tradeLogs.length > 200) state.tradeLogs.pop();
            if (state.tradeLogs.length % 5 === 0 || action.includes('‚úÖ') || action.includes('‚ùå')) {
                renderLogs();
            }
        }

        function renderLogs() {
            const icons = { claude: 'üß†', gemini: 'üíé', chatgpt: 'üöÄ', grok: '‚ö°', system: '‚öôÔ∏è' };
            const display = state.tradeLogs.slice(0, 50);
            
            const html = display.map(log => `
                <div class="bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg p-3">
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">${icons[log.source] || 'üìä'}</span>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-white">${log.source.toUpperCase()}</span>
                                <span class="text-xs text-gray-500">${log.timestamp}</span>
                            </div>
                            <p class="text-sm font-semibold mb-1 text-gray-300">${log.action}</p>
                            <p class="text-xs text-gray-400">${log.details}</p>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('tradeLogs').innerHTML = html || 
                '<div class="text-center text-gray-500 py-8">Chargez des donn√©es...</div>';
        }

        function clearLogs() {
            if (confirm('Effacer les logs ?')) {
                state.tradeLogs = [];
                renderLogs();
            }
        }

        console.log('üî¨ Ready - TradingView/Yahoo Finance Data');
    </script>
</body>
</html>
