<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Backtest R√©aliste - Strat√©gies de ton Bot</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            font-family: 'Arial', sans-serif;
            color: white;
        }
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .stat-card {
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .tx-link {
            color: #3b82f6;
            text-decoration: underline;
        }
        .tx-link:hover {
            color: #60a5fa;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">
    
    <div class="max-w-7xl mx-auto">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">
                üìä Backtest R√©aliste avec Vraies Donn√©es
            </h1>
            <p class="text-lg text-gray-300">
                Simulation exacte de ton bot sur donn√©es historiques r√©elles
            </p>
            <p class="text-sm text-gray-400 mt-2">
                üîó BSC Mainnet ‚Ä¢ ü•û PancakeSwap V2 ‚Ä¢ üí∞ Taxe 0.001 BNB
            </p>
        </div>

        <!-- Configuration -->
        <div class="card p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">‚öôÔ∏è Configuration du Backtest</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Crypto</label>
                    <select id="cryptoSelect" class="w-full p-3 border-2 border-gray-600 rounded-lg bg-gray-800 text-white">
                        <option value="BTCUSDT">Bitcoin (BTC)</option>
                        <option value="ETHUSDT">Ethereum (ETH)</option>
                        <option value="BNBUSDT">Binance Coin (BNB)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Capital Initial (USDT)</label>
                    <input type="number" id="capitalInput" value="1000" min="100" step="100" class="w-full p-3 border-2 border-gray-600 rounded-lg bg-gray-800 text-white">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Intervalle</label>
                    <select id="intervalSelect" class="w-full p-3 border-2 border-gray-600 rounded-lg bg-gray-800 text-white">
                        <option value="1m">1 minute</option>
                        <option value="5m">5 minutes</option>
                        <option value="15m" selected>15 minutes</option>
                        <option value="30m">30 minutes</option>
                        <option value="1h">1 heure</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Prix BNB (USDT)</label>
                    <input type="number" id="bnbPrice" value="600" min="1" step="10" class="w-full p-3 border-2 border-gray-600 rounded-lg bg-gray-800 text-white">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div class="flex items-center">
                    <input type="checkbox" id="aiClaude" checked class="w-5 h-5 mr-2">
                    <label class="text-sm">üß† Claude</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="aiGemini" checked class="w-5 h-5 mr-2">
                    <label class="text-sm">üíé Gemini</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="aiChatgpt" checked class="w-5 h-5 mr-2">
                    <label class="text-sm">üöÄ ChatGPT</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="aiGrok" checked class="w-5 h-5 mr-2">
                    <label class="text-sm">‚ö° Grok</label>
                </div>
            </div>
            
            <div class="bg-blue-900 bg-opacity-50 border-2 border-blue-500 rounded-lg p-4 mb-4">
                <p class="text-blue-200 font-bold mb-2">‚úÖ FRAIS R√âELS INCLUS</p>
                <ul class="text-sm text-blue-300 space-y-1">
                    <li>‚Ä¢ <strong>PancakeSwap:</strong> 0.25% par swap</li>
                    <li>‚Ä¢ <strong>Slippage:</strong> 2% par trade</li>
                    <li>‚Ä¢ <strong>Taxe JERCAT:</strong> 0.001 BNB par trade (~$0.60)</li>
                    <li>‚Ä¢ <strong>Gas BSC:</strong> ~0.003 BNB par TX (~$1.80)</li>
                    <li>‚Ä¢ <strong>Total frais:</strong> ~4.5% + $2.40 par trade</li>
                </ul>
            </div>
            
            <button id="runBacktest" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-4 rounded-lg transition-all shadow-lg">
                üöÄ Lancer le Backtest R√©aliste
            </button>
        </div>

        <!-- Loading -->
        <div id="loading" class="card p-8 mb-6 text-center" style="display: none;">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-purple-500 mx-auto mb-4"></div>
            <p class="font-semibold">R√©cup√©ration donn√©es Binance...</p>
            <p class="text-sm text-gray-400 mt-2" id="loadingProgress">0%</p>
        </div>

        <!-- Results -->
        <div id="results" style="display: none;">
            
            <!-- R√©sum√© global -->
            <div class="card p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4">üìà R√©sum√© du Backtest</h2>
                <div id="summary" class="grid grid-cols-1 md:grid-cols-4 gap-4"></div>
            </div>

            <!-- Classement -->
            <div class="card p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4">üèÜ Classement des IA</h2>
                <div id="ranking" class="space-y-3"></div>
            </div>

            <!-- Stats par IA -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6" id="aiStats"></div>

            <!-- Graphique capital -->
            <div class="card p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4">üìä √âvolution du Capital</h2>
                <canvas id="capitalChart"></canvas>
            </div>

            <!-- Graphique prix + trades -->
            <div class="card p-6 mb-6">
                <h2 class="text-2xl font-bold mb-4">üíπ Prix et Points de Trade</h2>
                <canvas id="priceChart"></canvas>
            </div>

            <!-- Journal d√©taill√© -->
            <div class="card p-6">
                <h2 class="text-2xl font-bold mb-4">üìù Journal Complet des Trades</h2>
                <div class="text-sm text-gray-400 mb-4">
                    <p>Chaque trade montre les TX qui auraient √©t√© faites sur BSC</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-gray-800 bg-opacity-50">
                                <th class="p-2 text-left">IA</th>
                                <th class="p-2 text-left">Action</th>
                                <th class="p-2 text-left">Date/Heure</th>
                                <th class="p-2 text-right">Prix</th>
                                <th class="p-2 text-right">Montant</th>
                                <th class="p-2 text-right">Frais Total</th>
                                <th class="p-2 text-right">Profit Net</th>
                                <th class="p-2 text-left">TX Simul√©es</th>
                            </tr>
                        </thead>
                        <tbody id="tradesTable"></tbody>
                    </table>
                </div>
            </div>

        </div>

    </div>

    <script>
        // Configuration exacte de ton bot
        const CONFIG = {
            TRADE_FEE_BNB: 0.001,
            GAS_PER_TX: 0.003,
            PANCAKESWAP_FEE: 0.0025,
            SLIPPAGE: 0.02,
            MIN_TRADE: 10,
            TRADE_PERCENT: 0.3
        };

        const AI_STRATEGIES = {
            claude: {
                name: 'Claude',
                icon: 'üß†',
                color: '#10b981',
                rsiOversold: 30,
                rsiOverbought: 70,
                takeProfitPercent: 2,
                stopLossPercent: -1,
                maxHoldPeriods: 30
            },
            gemini: {
                name: 'Gemini',
                icon: 'üíé',
                color: '#3b82f6',
                rsiOversold: 35,
                rsiOverbought: 65,
                takeProfitPercent: 3,
                stopLossPercent: -1.5,
                maxHoldPeriods: 40
            },
            chatgpt: {
                name: 'ChatGPT',
                icon: 'üöÄ',
                color: '#8b5cf6',
                rsiOversold: 40,
                rsiOverbought: 60,
                takeProfitPercent: 4,
                stopLossPercent: -2,
                maxHoldPeriods: 50
            },
            grok: {
                name: 'Grok',
                icon: '‚ö°',
                color: '#f59e0b',
                rsiOversold: 45,
                rsiOverbought: 55,
                takeProfitPercent: 5,
                stopLossPercent: -2.5,
                maxHoldPeriods: 60
            }
        };

        let charts = {};

        // R√©cup√©rer donn√©es historiques Binance
        async function fetchHistoricalData(symbol, interval) {
            const endTime = Date.now();
            const startTime = endTime - (7 * 24 * 60 * 60 * 1000);
            
            const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&startTime=${startTime}&endTime=${endTime}&limit=1000`;
            
            const response = await fetch(url);
            return await response.json();
        }

        // Calculer RSI
        function calculateRSI(prices, period = 14) {
            if (prices.length < period + 1) return 50;
            
            let gains = 0, losses = 0;
            
            for (let i = prices.length - period; i < prices.length; i++) {
                const change = prices[i] - prices[i - 1];
                if (change > 0) gains += change;
                else losses += Math.abs(change);
            }
            
            const avgGain = gains / period;
            const avgLoss = losses / period;
            
            if (avgLoss === 0) return 100;
            return 100 - (100 / (1 + (avgGain / avgLoss)));
        }

        // Calculer EMA
        function calculateEMA(prices, period) {
            if (prices.length < period) return prices[prices.length - 1];
            
            const k = 2 / (period + 1);
            let ema = prices[0];
            
            for (let i = 1; i < prices.length; i++) {
                ema = prices[i] * k + ema * (1 - k);
            }
            
            return ema;
        }

        // D√©cision d'achat (D√âTERMINISTE - pas de random)
        function shouldBuy(aiName, currentPrice, priceHistory, rsi, ema20, ema50) {
            const strategy = AI_STRATEGIES[aiName];
            
            // Logique bas√©e sur RSI et EMA
            const rsiSignal = rsi < strategy.rsiOversold;
            const emaSignal = ema20 > ema50; // Golden cross
            const momentum = (currentPrice - priceHistory[priceHistory.length - 10]) / priceHistory[priceHistory.length - 10];
            
            // Chaque IA a sa propre logique
            switch(aiName) {
                case 'claude':
                    return rsiSignal && emaSignal;
                case 'gemini':
                    return rsiSignal && momentum > 0.01;
                case 'chatgpt':
                    return emaSignal && momentum > 0.015;
                case 'grok':
                    return rsi < 50 && momentum > 0.02;
                default:
                    return false;
            }
        }

        // D√©cision de vente (D√âTERMINISTE)
        function shouldSell(aiName, entryPrice, currentPrice, holdPeriods, rsi) {
            const strategy = AI_STRATEGIES[aiName];
            const profitPercent = ((currentPrice - entryPrice) / entryPrice) * 100;
            
            // Take profit
            if (profitPercent >= strategy.takeProfitPercent) return true;
            
            // Stop loss
            if (profitPercent <= strategy.stopLossPercent) return true;
            
            // Max hold time
            if (holdPeriods >= strategy.maxHoldPeriods) return true;
            
            // RSI overbought
            if (rsi > strategy.rsiOverbought) return true;
            
            return false;
        }

        // Calculer frais r√©els
        function calculateFees(tradeAmount, bnbPrice) {
            const pancakeswapFee = tradeAmount * CONFIG.PANCAKESWAP_FEE;
            const slippageLoss = tradeAmount * CONFIG.SLIPPAGE;
            const taxBNB = CONFIG.TRADE_FEE_BNB * bnbPrice;
            const gasBNB = CONFIG.GAS_PER_TX * 2 * bnbPrice; // 2 TX (approve + swap)
            
            return {
                pancakeswap: pancakeswapFee,
                slippage: slippageLoss,
                tax: taxBNB,
                gas: gasBNB,
                total: pancakeswapFee + slippageLoss + taxBNB + gasBNB
            };
        }

        // Simuler une TX
        function generateTxHash() {
            return '0x' + Array.from({length: 64}, () => 
                Math.floor(Math.random() * 16).toString(16)
            ).join('');
        }

        // Lancer le backtest
        async function runBacktest() {
            const symbol = document.getElementById('cryptoSelect').value;
            const capital = parseFloat(document.getElementById('capitalInput').value);
            const interval = document.getElementById('intervalSelect').value;
            const bnbPrice = parseFloat(document.getElementById('bnbPrice').value);
            
            const activeAIs = {};
            ['claude', 'gemini', 'chatgpt', 'grok'].forEach(ai => {
                if (document.getElementById(`ai${ai.charAt(0).toUpperCase() + ai.slice(1)}`).checked) {
                    activeAIs[ai] = true;
                }
            });

            if (Object.keys(activeAIs).length === 0) {
                alert('‚ùå S√©lectionnez au moins une IA');
                return;
            }
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            
            document.getElementById('loadingProgress').textContent = 'R√©cup√©ration donn√©es Binance...';
            
            const rawData = await fetchHistoricalData(symbol, interval);
            const candles = rawData.map(c => ({
                timestamp: c[0],
                open: parseFloat(c[1]),
                high: parseFloat(c[2]),
                low: parseFloat(c[3]),
                close: parseFloat(c[4]),
                volume: parseFloat(c[5])
            }));
            
            // Initialiser les IA
            const aiStates = {};
            Object.keys(activeAIs).forEach(ai => {
                aiStates[ai] = {
                    capital: capital,
                    position: null,
                    trades: [],
                    capitalHistory: [capital],
                    totalFees: 0,
                    transactions: []
                };
            });
            
            const prices = candles.map(c => c.close);
            
            // Simulation
            for (let i = 50; i < candles.length; i++) {
                const currentPrice = candles[i].close;
                const timestamp = candles[i].timestamp;
                const priceHistory = prices.slice(0, i + 1);
                
                const rsi = calculateRSI(priceHistory);
                const ema20 = calculateEMA(priceHistory, 20);
                const ema50 = calculateEMA(priceHistory, 50);
                
                document.getElementById('loadingProgress').textContent = 
                    `Simulation... ${Math.round((i / candles.length) * 100)}%`;
                
                // Chaque IA prend sa d√©cision
                for (const [aiName, state] of Object.entries(aiStates)) {
                    if (!state.position) {
                        // Pas de position - regarder si achat
                        if (shouldBuy(aiName, currentPrice, priceHistory, rsi, ema20, ema50)) {
                            const tradeAmount = state.capital * CONFIG.TRADE_PERCENT;
                            
                            if (tradeAmount < CONFIG.MIN_TRADE) continue;
                            
                            const fees = calculateFees(tradeAmount, bnbPrice);
                            const netAmount = tradeAmount - fees.total;
                            const tokens = netAmount / currentPrice;
                            
                            // G√©n√©rer TX simul√©es
                            const taxTx = generateTxHash();
                            const approveTx = generateTxHash();
                            const swapTx = generateTxHash();
                            
                            state.position = {
                                entryPrice: currentPrice,
                                entryIndex: i,
                                amount: tradeAmount,
                                tokens: tokens,
                                timestamp: timestamp,
                                fees: fees
                            };
                            
                            state.totalFees += fees.total;
                            
                            state.trades.push({
                                type: 'BUY',
                                price: currentPrice,
                                amount: tradeAmount,
                                fees: fees,
                                timestamp: timestamp,
                                index: i,
                                transactions: [
                                    { type: 'TAX', tx: taxTx, amount: fees.tax },
                                    { type: 'APPROVE', tx: approveTx, gas: fees.gas / 2 },
                                    { type: 'SWAP', tx: swapTx, amount: netAmount }
                                ]
                            });
                            
                            state.transactions.push(...[
                                { type: 'TAX', tx: taxTx, time: timestamp },
                                { type: 'APPROVE', tx: approveTx, time: timestamp },
                                { type: 'SWAP BUY', tx: swapTx, time: timestamp }
                            ]);
                        }
                    } else {
                        // Position ouverte - regarder si vente
                        const holdPeriods = i - state.position.entryIndex;
                        
                        if (shouldSell(aiName, state.position.entryPrice, currentPrice, holdPeriods, rsi)) {
                            const grossValue = state.position.tokens * currentPrice;
                            const fees = calculateFees(grossValue, bnbPrice);
                            const netValue = grossValue - fees.total;
                            const profit = netValue - state.position.amount;
                            
                            state.capital += profit;
                            state.totalFees += fees.total;
                            
                            // G√©n√©rer TX
                            const taxTx = generateTxHash();
                            const approveTx = generateTxHash();
                            const swapTx = generateTxHash();
                            
                            state.trades.push({
                                type: 'SELL',
                                price: currentPrice,
                                amount: netValue,
                                fees: fees,
                                profit: profit,
                                timestamp: timestamp,
                                index: i,
                                holdPeriods: holdPeriods,
                                transactions: [
                                    { type: 'TAX', tx: taxTx, amount: fees.tax },
                                    { type: 'APPROVE', tx: approveTx, gas: fees.gas / 2 },
                                    { type: 'SWAP', tx: swapTx, amount: netValue }
                                ]
                            });
                            
                            state.transactions.push(...[
                                { type: 'TAX', tx: taxTx, time: timestamp },
                                { type: 'APPROVE', tx: approveTx, time: timestamp },
                                { type: 'SWAP SELL', tx: swapTx, time: timestamp }
                            ]);
                            
                            state.position = null;
                        }
                    }
                    
                    // Capital actuel
                    let currentCapital = state.capital;
                    if (state.position) {
                        const posValue = state.position.tokens * currentPrice;
                        const exitFees = calculateFees(posValue, bnbPrice);
                        currentCapital += posValue - state.position.amount - exitFees.total;
                    }
                    state.capitalHistory.push(currentCapital);
                }
            }
            
            displayResults(aiStates, candles, capital, bnbPrice);
        }

        // Afficher r√©sultats
        function displayResults(aiStates, candles, initialCapital, bnbPrice) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results').style.display = 'block';
            
            const rankings = Object.entries(aiStates).map(([name, state]) => {
                const finalCapital = state.capitalHistory[state.capitalHistory.length - 1];
                const profit = finalCapital - initialCapital;
                const profitPercent = (profit / initialCapital) * 100;
                
                const sellTrades = state.trades.filter(t => t.type === 'SELL');
                const wins = sellTrades.filter(t => t.profit > 0).length;
                const losses = sellTrades.filter(t => t.profit < 0).length;
                const winRate = wins + losses > 0 ? (wins / (wins + losses)) * 100 : 0;
                
                return {
                    name,
                    config: AI_STRATEGIES[name],
                    finalCapital,
                    profit,
                    profitPercent,
                    totalTrades: state.trades.length,
                    sellTrades: sellTrades.length,
                    wins,
                    losses,
                    winRate,
                    totalFees: state.totalFees,
                    totalTx: state.transactions.length
                };
            }).sort((a, b) => b.profit - a.profit);
            
            // R√©sum√© global
            const totalTrades = rankings.reduce((sum, ai) => sum + ai.totalTrades, 0);
            const totalFees = rankings.reduce((sum, ai) => sum + ai.totalFees, 0);
            const totalTx = rankings.reduce((sum, ai) => sum + ai.totalTx, 0);
            const bestProfit = rankings[0].profit;
            
            const summaryHTML = `
                <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-400">P√©riode</p>
                    <p class="text-xl font-bold">${new Date(candles[50].timestamp).toLocaleDateString()} - ${new Date(candles[candles.length-1].timestamp).toLocaleDateString()}</p>
                </div>
                <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-400">Total Trades</p>
                    <p class="text-xl font-bold">${totalTrades} trades</p>
                    <p class="text-xs text-gray-400">${totalTx} TX simul√©es</p>
                </div>
                <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-400">Frais Totaux</p>
                    <p class="text-xl font-bold text-red-400">-$${totalFees.toFixed(2)}</p>
                    <p class="text-xs text-gray-400">~${(totalFees / bnbPrice).toFixed(3)} BNB</p>
                </div>
                <div class="bg-gray-800 bg-opacity-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-400">Meilleur R√©sultat</p>
                    <p class="text-xl font-bold ${bestProfit >= 0 ? 'text-green-400' : 'text-red-400'}">
                        ${bestProfit >= 0 ? '+' : ''}$${bestProfit.toFixed(2)}
                    </p>
                    <p class="text-xs text-gray-400">${rankings[0].config.icon} ${rankings[0].config.name}</p>
                </div>
            `;
            document.getElementById('summary').innerHTML = summaryHTML;
            
            // Classement
            const medals = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£'];
            const rankingHTML = rankings.map((ai, idx) => {
                const profitColor = ai.profit >= 0 ? 'text-green-400' : 'text-red-400';
                
                return `
                    <div class="flex items-center justify-between p-4 bg-gray-800 bg-opacity-50 rounded-lg">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${medals[idx]}</span>
                            <span class="text-2xl">${ai.config.icon}</span>
                            <div>
                                <p class="font-bold">${ai.config.name}</p>
                                <p class="text-sm text-gray-400">
                                    ${ai.totalTrades} trades ‚Ä¢ ${ai.winRate.toFixed(1)}% win ‚Ä¢ ${ai.totalTx} TX
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold ${profitColor} text-lg">
                                ${ai.profit >= 0 ? '+' : ''}$${ai.profit.toFixed(2)}
                            </p>
                            <p class="text-sm ${profitColor}">
                                ${ai.profitPercent >= 0 ? '+' : ''}${ai.profitPercent.toFixed(2)}%
                            </p>
                            <p class="text-xs text-red-400">Frais: $${ai.totalFees.toFixed(2)}</p>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('ranking').innerHTML = rankingHTML;
            
            // Stats d√©taill√©es
            const statsHTML = rankings.map(ai => `
                <div class="card p-6 stat-card">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-3xl">${ai.config.icon}</span>
                        <h3 class="font-bold">${ai.config.name}</h3>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Capital final:</span>
                            <span class="font-bold">$${ai.finalCapital.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Profit Net:</span>
                            <span class="font-bold ${ai.profit >= 0 ? 'text-green-400' : 'text-red-400'}">
                                ${ai.profit >= 0 ? '+' : ''}$${ai.profit.toFixed(2)}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Trades:</span>
                            <span class="font-bold">${ai.totalTrades}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Win/Loss:</span>
                            <span class="font-bold">${ai.wins}/${ai.losses}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Win Rate:</span>
                            <span class="font-bold">${ai.winRate.toFixed(1)}%</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Frais Total:</span>
                            <span class="font-bold text-red-400">$${ai.totalFees.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">TX Totales:</span>
                            <span class="font-bold text-blue-400">${ai.totalTx}</span>
                        </div>
                    </div>
                </div>
            `).join('');
            document.getElementById('aiStats').innerHTML = statsHTML;
            
            // Graphique capital
            drawCapitalChart(aiStates);
            
            // Graphique prix
            drawPriceChart(candles, aiStates);
            
            // Table trades
            drawTradesTable(aiStates);
        }

        // Graphique capital
        function drawCapitalChart(aiStates) {
            const ctx = document.getElementById('capitalChart').getContext('2d');
            
            if (charts.capital) charts.capital.destroy();
            
            const datasets = Object.entries(aiStates).map(([name, state]) => ({
                label: AI_STRATEGIES[name].name,
                data: state.capitalHistory,
                borderColor: AI_STRATEGIES[name].color,
                backgroundColor: AI_STRATEGIES[name].color + '40',
                tension: 0.4,
                fill: false
            }));
            
            charts.capital = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: { color: 'white' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { 
                                color: 'white',
                                callback: v => '$' + v.toFixed(0)
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        // Graphique prix
        function drawPriceChart(candles, aiStates) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (charts.price) charts.price.destroy();
            
            const priceData = candles.map(c => c.close);
            
            charts.price = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: candles.map((c, i) => i),
                    datasets: [{
                        label: 'Prix',
                        data: priceData,
                        borderColor: '#6366f1',
                        backgroundColor: '#6366f140',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { 
                            labels: { color: 'white' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { 
                                color: 'white',
                                callback: v => '$' + v.toFixed(0)
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        // Table trades
        function drawTradesTable(aiStates) {
            const allTrades = [];
            
            Object.entries(aiStates).forEach(([aiName, state]) => {
                state.trades.forEach(trade => {
                    allTrades.push({
                        ...trade,
                        aiName,
                        config: AI_STRATEGIES[aiName]
                    });
                });
            });
            
            allTrades.sort((a, b) => b.timestamp - a.timestamp);
            
            const tradesHTML = allTrades.slice(0, 100).map(trade => {
                const date = new Date(trade.timestamp).toLocaleString('fr-FR');
                const typeColor = trade.type === 'BUY' ? 'text-green-400' : 'text-red-400';
                
                const txLinks = trade.transactions.map(tx => 
                    `<a href="https://bscscan.com/tx/${tx.tx}" target="_blank" class="tx-link text-xs">
                        ${tx.type}
                    </a>`
                ).join(' ‚Ä¢ ');
                
                const profitHTML = trade.profit !== undefined ? 
                    `<span class="${trade.profit >= 0 ? 'text-green-400' : 'text-red-400'} font-bold">
                        ${trade.profit >= 0 ? '+' : ''}$${trade.profit.toFixed(2)}
                    </span>` : '-';
                
                return `
                    <tr class="border-b border-gray-700 hover:bg-gray-800 hover:bg-opacity-30">
                        <td class="p-2">
                            <span class="text-lg">${trade.config.icon}</span>
                            ${trade.config.name}
                        </td>
                        <td class="p-2 ${typeColor} font-bold">${trade.type}</td>
                        <td class="p-2 text-gray-400 text-xs">${date}</td>
                        <td class="p-2 text-right">$${trade.price.toFixed(2)}</td>
                        <td class="p-2 text-right">$${trade.amount.toFixed(2)}</td>
                        <td class="p-2 text-right text-red-400">$${trade.fees.total.toFixed(2)}</td>
                        <td class="p-2 text-right">${profitHTML}</td>
                        <td class="p-2 text-xs">${txLinks}</td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('tradesTable').innerHTML = tradesHTML;
        }

        // Event
        document.getElementById('runBacktest').addEventListener('click', runBacktest);
    </script>

</body>
</html>
