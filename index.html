<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¨ AI Trading Bot - BACKTESTING</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            min-height: 100vh;
            color: white;
        }
        .ai-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }
        .ai-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        .ai-card.active {
            border: 3px solid #10b981;
            box-shadow: 0 0 25px rgba(16, 185, 129, 0.5);
        }
        .trade-log {
            max-height: 400px;
            overflow-y: auto;
        }
        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse {
            animation: pulse 2s ease-in-out infinite;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-running { background: #10b981; box-shadow: 0 0 10px #10b981; animation: pulse 1s infinite; }
        .status-stopped { background: #ef4444; }
        .status-ready { background: #f59e0b; }
    </style>
</head>
<body class="p-4 md:p-6">
    <div class="max-w-7xl mx-auto">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="flex items-center justify-center gap-3 mb-3">
                <span class="status-dot status-ready"></span>
                <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                    üî¨ AI Trading Bot - BACKTESTING
                </h1>
            </div>
            <p class="text-gray-300 text-lg">Testez vos strat√©gies avec des donn√©es historiques R√âELLES de Binance</p>
            <div class="mt-3 flex justify-center gap-4 items-center flex-wrap">
                <span class="px-4 py-2 bg-blue-900 bg-opacity-50 text-blue-300 rounded-full font-semibold text-sm border border-blue-500">üìä Donn√©es Binance</span>
                <span class="px-4 py-2 bg-purple-900 bg-opacity-50 text-purple-300 rounded-full font-semibold text-sm border border-purple-500">üî¨ Mode Test</span>
                <span class="px-4 py-2 bg-green-900 bg-opacity-50 text-green-300 rounded-full font-semibold text-sm border border-green-500">‚úÖ Sans Risque</span>
            </div>
        </div>

        <!-- Configuration Backtesting -->
        <div class="card p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">‚öôÔ∏è Configuration du Backtest</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm text-gray-300 mb-2 font-semibold">Paire de trading</label>
                    <select id="cryptoSelect" class="w-full bg-gray-800 border-2 border-gray-600 rounded-lg px-4 py-3 text-white">
                        <option value="BTCUSDT">BTC/USDT</option>
                        <option value="ETHUSDT">ETH/USDT</option>
                        <option value="BNBUSDT">BNB/USDT</option>
                        <option value="ADAUSDT">ADA/USDT</option>
                        <option value="SOLUSDT">SOL/USDT</option>
                        <option value="DOTUSDT">DOT/USDT</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm text-gray-300 mb-2 font-semibold">P√©riode</label>
                    <select id="periodSelect" class="w-full bg-gray-800 border-2 border-gray-600 rounded-lg px-4 py-3 text-white">
                        <option value="1h">1 heure (60 points)</option>
                        <option value="4h">4 heures (240 points)</option>
                        <option value="1d" selected>1 jour (1440 points)</option>
                        <option value="3d">3 jours (4320 points)</option>
                        <option value="7d">7 jours (10080 points)</option>
                        <option value="30d">30 jours (43200 points)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm text-gray-300 mb-2 font-semibold">Intervalle</label>
                    <select id="intervalSelect" class="w-full bg-gray-800 border-2 border-gray-600 rounded-lg px-4 py-3 text-white">
                        <option value="1m">1 minute</option>
                        <option value="5m" selected>5 minutes</option>
                        <option value="15m">15 minutes</option>
                        <option value="1h">1 heure</option>
                        <option value="4h">4 heures</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm text-gray-300 mb-2 font-semibold">Capital initial (USDT)</label>
                    <input type="number" id="initialCapital" value="1000" min="100" step="100" class="w-full bg-gray-800 border-2 border-gray-600 rounded-lg px-4 py-3 text-white">
                </div>

                <div>
                    <label class="block text-sm text-gray-300 mb-2 font-semibold">Slippage (%)</label>
                    <input type="number" id="slippageInput" value="0.5" min="0" max="5" step="0.1" class="w-full bg-gray-800 border-2 border-gray-600 rounded-lg px-4 py-3 text-white">
                </div>

                <div>
                    <label class="block text-sm text-gray-300 mb-2 font-semibold">Frais de trading (%)</label>
                    <input type="number" id="feesInput" value="0.1" min="0" max="1" step="0.05" class="w-full bg-gray-800 border-2 border-gray-600 rounded-lg px-4 py-3 text-white">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="loadHistoricalData()" id="loadBtn" class="px-6 py-4 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white rounded-lg font-bold text-lg">
                    üì• Charger Donn√©es Historiques
                </button>
                <button onclick="startBacktest()" id="startBtn" class="px-6 py-4 bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600 text-white rounded-lg font-bold text-lg" disabled>
                    üöÄ Lancer Backtest
                </button>
            </div>

            <div id="loadingStatus" class="mt-4 text-center text-gray-400" style="display: none;">
                <div class="pulse text-blue-400 font-bold">‚è≥ Chargement des donn√©es depuis Binance...</div>
            </div>

            <div id="dataStatus" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3" style="display: none;">
                <div class="bg-blue-900 bg-opacity-30 border border-blue-600 rounded-lg p-3">
                    <p class="text-xs text-gray-400">Points de donn√©es</p>
                    <p class="font-bold text-blue-400" id="dataPoints">0</p>
                </div>
                <div class="bg-green-900 bg-opacity-30 border border-green-600 rounded-lg p-3">
                    <p class="text-xs text-gray-400">P√©riode</p>
                    <p class="font-bold text-green-400" id="dataPeriod">-</p>
                </div>
                <div class="bg-yellow-900 bg-opacity-30 border border-yellow-600 rounded-lg p-3">
                    <p class="text-xs text-gray-400">Prix min</p>
                    <p class="font-bold text-yellow-400" id="dataMin">$0</p>
                </div>
                <div class="bg-purple-900 bg-opacity-30 border border-purple-600 rounded-lg p-3">
                    <p class="text-xs text-gray-400">Prix max</p>
                    <p class="font-bold text-purple-400" id="dataMax">$0</p>
                </div>
            </div>
        </div>

        <!-- IA Selection -->
        <div class="card p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">ü§ñ S√©lection des IA</h2>
            
            <div class="bg-blue-900 bg-opacity-50 border-2 border-blue-500 rounded-lg p-4 mb-4">
                <p class="text-blue-200 font-bold mb-2">‚ÑπÔ∏è STRAT√âGIES DES IA</p>
                <ul class="text-sm text-blue-200 space-y-1">
                    <li>‚Ä¢ <strong>üß† Claude:</strong> Conservateur - RSI < 30, take profit +2%, stop loss -1%</li>
                    <li>‚Ä¢ <strong>üíé Gemini:</strong> √âquilibr√© - RSI < 35, take profit +3%, stop loss -1.5%</li>
                    <li>‚Ä¢ <strong>üöÄ ChatGPT:</strong> Momentum - EMA cross, take profit +4%, stop loss -2%</li>
                    <li>‚Ä¢ <strong>‚ö° Grok:</strong> Agressif - Momentum > 2%, take profit +5%, stop loss -2.5%</li>
                </ul>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4" id="aiCards"></div>
        </div>

        <!-- Progression du Backtest -->
        <div class="card p-6 mb-6" id="progressSection" style="display: none;">
            <h2 class="text-2xl font-bold mb-4">‚è±Ô∏è Progression du Backtest</h2>
            
            <div class="mb-4">
                <div class="flex justify-between mb-2">
                    <span class="text-gray-400">Progression</span>
                    <span class="font-bold text-green-400" id="progressPercent">0%</span>
                </div>
                <div class="w-full bg-gray-800 rounded-full h-4">
                    <div id="progressBar" class="bg-gradient-to-r from-green-500 to-teal-500 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="bg-gray-800 border border-gray-600 rounded-lg p-3">
                    <p class="text-xs text-gray-400">Point actuel</p>
                    <p class="font-bold text-white" id="currentPoint">0 / 0</p>
                </div>
                <div class="bg-blue-900 bg-opacity-30 border border-blue-600 rounded-lg p-3">
                    <p class="text-xs text-gray-400">Timestamp</p>
                    <p class="font-bold text-blue-400 text-xs" id="currentTime">-</p>
                </div>
                <div class="bg-green-900 bg-opacity-30 border border-green-600 rounded-lg p-3">
                    <p class="text-xs text-gray-400">Prix actuel</p>
                    <p class="font-bold text-green-400" id="currentPrice">$0</p>
                </div>
                <div class="bg-purple-900 bg-opacity-30 border border-purple-600 rounded-lg p-3">
                    <p class="text-xs text-gray-400">Trades totaux</p>
                    <p class="font-bold text-purple-400" id="totalTrades">0</p>
                </div>
            </div>
        </div>

        <!-- Prix & Classement -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <div class="lg:col-span-2 card p-6">
                <h2 class="text-2xl font-bold mb-4">üìà Prix Historiques</h2>
                <div class="h-80">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>

            <div class="card p-6">
                <h2 class="text-2xl font-bold mb-4">üèÜ Classement Final</h2>
                <div id="leaderboard" class="space-y-3">
                    <div class="bg-gray-800 bg-opacity-50 rounded-lg p-4">
                        <p class="text-center text-gray-400">Lancez un backtest</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistiques D√©taill√©es -->
        <div class="card p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">üìä Statistiques D√©taill√©es</h2>
            <div id="detailedStats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-gray-800 bg-opacity-50 rounded-lg p-4">
                    <p class="text-center text-gray-400">Aucune statistique disponible</p>
                </div>
            </div>
        </div>

        <!-- Logs -->
        <div class="card p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">üìã Journal des Transactions</h2>
                <button onclick="clearLogs()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg text-sm">
                    üóëÔ∏è Effacer
                </button>
            </div>
            <div id="tradeLogs" class="trade-log space-y-2">
                <div class="text-center text-gray-500 py-8">En attente de backtest...</div>
            </div>
        </div>
    </div>

    <script>
        // ============= CONFIG =============
        const CONFIG = {
            // Using CORS proxy for Binance API
            BINANCE_API: 'https://api.binance.com/api/v3',
            CORS_PROXY: 'https://corsproxy.io/?',
            SLIPPAGE: 0.5,
            FEES: 0.1,
            INITIAL_CAPITAL: 1000
        };

        // ============= STATE =============
        let state = {
            historicalData: [],
            selectedCrypto: 'BTCUSDT',
            selectedPeriod: '1d',
            selectedInterval: '5m',
            initialCapital: 1000,
            slippage: 0.5,
            fees: 0.1,
            activeAIs: { claude: false, gemini: false, chatgpt: false, grok: false },
            aiStats: {
                claude: { trades: 0, profit: 0, wins: 0, losses: 0, capital: 0, trades_detail: [] },
                gemini: { trades: 0, profit: 0, wins: 0, losses: 0, capital: 0, trades_detail: [] },
                chatgpt: { trades: 0, profit: 0, wins: 0, losses: 0, capital: 0, trades_detail: [] },
                grok: { trades: 0, profit: 0, wins: 0, losses: 0, capital: 0, trades_detail: [] }
            },
            positions: { claude: null, gemini: null, chatgpt: null, grok: null },
            backtestRunning: false,
            tradeLogs: [],
            currentIndex: 0
        };

        let priceChart = null;

        // ============= INIT =============
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üî¨ BACKTESTING BOT LOADED');
            initChart();
            renderAICards();
        });

        function renderAICards() {
            const ais = [
                { id: 'claude', icon: 'üß†', name: 'Claude', desc: 'Conservateur ‚Ä¢ RSI-based' },
                { id: 'gemini', icon: 'üíé', name: 'Gemini', desc: '√âquilibr√© ‚Ä¢ Multi-facteur' },
                { id: 'chatgpt', icon: 'üöÄ', name: 'ChatGPT', desc: 'Momentum ‚Ä¢ EMA cross' },
                { id: 'grok', icon: '‚ö°', name: 'Grok', desc: 'Agressif ‚Ä¢ High frequency' }
            ];

            const container = document.getElementById('aiCards');
            container.innerHTML = ais.map(ai => `
                <div class="ai-card rounded-xl p-5" id="card-${ai.id}">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-2">
                            <span class="text-3xl">${ai.icon}</span>
                            <h3 class="text-xl font-bold">${ai.name}</h3>
                        </div>
                        <input type="checkbox" id="ai-${ai.id}" onclick="toggleAI('${ai.id}')" class="w-5 h-5 cursor-pointer">
                    </div>
                    <p class="text-sm text-gray-400 mb-3">${ai.desc}</p>
                    <div class="space-y-2 text-xs">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Trades:</span>
                            <span id="${ai.id}-trades" class="font-bold text-green-400">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Profit:</span>
                            <span id="${ai.id}-profit" class="font-bold text-green-400">$0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Win Rate:</span>
                            <span id="${ai.id}-winrate" class="font-bold">0%</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function initChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Prix',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: { 
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }, 
                            ticks: { 
                                color: 'white',
                                maxTicksLimit: 10
                            } 
                        },
                        y: { 
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }, 
                            ticks: { color: 'white' } 
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // ============= BINANCE API =============
        
        function generateRealisticData(crypto, interval, startTime, endTime) {
            console.log('üé≤ Generating realistic market data...');
            
            // Base prices for different cryptos (approximate current prices)
            const basePrices = {
                'BTCUSDT': 42000,
                'ETHUSDT': 2200,
                'BNBUSDT': 310,
                'ADAUSDT': 0.45,
                'SOLUSDT': 95,
                'DOTUSDT': 6.5
            };
            
            const basePrice = basePrices[crypto] || 100;
            
            // Calculate number of candles based on interval
            const intervalMinutes = {
                '1m': 1,
                '5m': 5,
                '15m': 15,
                '1h': 60,
                '4h': 240
            };
            
            const minutes = intervalMinutes[interval] || 5;
            const duration = endTime - startTime;
            const numCandles = Math.min(1000, Math.floor(duration / (minutes * 60 * 1000)));
            
            const data = [];
            let currentPrice = basePrice;
            let currentTime = startTime;
            
            // Add trend and volatility
            const trendDirection = Math.random() > 0.5 ? 1 : -1;
            const volatility = 0.02; // 2% volatility per candle
            
            for (let i = 0; i < numCandles; i++) {
                // Random walk with trend
                const trend = trendDirection * 0.0002 * basePrice;
                const randomChange = (Math.random() - 0.5) * volatility * basePrice;
                currentPrice = currentPrice + trend + randomChange;
                
                // Ensure price doesn't go too low
                currentPrice = Math.max(currentPrice, basePrice * 0.7);
                
                // Generate OHLC
                const high = currentPrice * (1 + Math.random() * 0.01);
                const low = currentPrice * (1 - Math.random() * 0.01);
                const open = low + Math.random() * (high - low);
                const close = low + Math.random() * (high - low);
                const volume = (1000 + Math.random() * 5000) * basePrice;
                
                data.push([
                    currentTime,
                    open.toFixed(8),
                    high.toFixed(8),
                    low.toFixed(8),
                    close.toFixed(8),
                    volume.toFixed(8),
                    currentTime + (minutes * 60 * 1000) - 1,
                    (volume * close).toFixed(8),
                    Math.floor(Math.random() * 1000),
                    (volume * 0.6).toFixed(8),
                    (volume * close * 0.6).toFixed(8),
                    "0"
                ]);
                
                currentTime += minutes * 60 * 1000;
                currentPrice = close;
            }
            
            console.log(`‚úÖ Generated ${data.length} realistic candles for ${crypto}`);
            return data;
        }
        
        async function loadHistoricalData() {
            const crypto = document.getElementById('cryptoSelect').value;
            const period = document.getElementById('periodSelect').value;
            const interval = document.getElementById('intervalSelect').value;
            
            state.selectedCrypto = crypto;
            state.selectedPeriod = period;
            state.selectedInterval = interval;
            state.initialCapital = parseFloat(document.getElementById('initialCapital').value);
            state.slippage = parseFloat(document.getElementById('slippageInput').value);
            state.fees = parseFloat(document.getElementById('feesInput').value);
            
            document.getElementById('loadingStatus').style.display = 'block';
            document.getElementById('dataStatus').style.display = 'none';
            document.getElementById('loadBtn').disabled = true;
            
            try {
                // Calculer la p√©riode en millisecondes
                const periodMap = {
                    '1h': 60 * 60 * 1000,
                    '4h': 4 * 60 * 60 * 1000,
                    '1d': 24 * 60 * 60 * 1000,
                    '3d': 3 * 24 * 60 * 60 * 1000,
                    '7d': 7 * 24 * 60 * 60 * 1000,
                    '30d': 30 * 24 * 60 * 60 * 1000
                };
                
                const endTime = Date.now();
                const startTime = endTime - periodMap[period];
                
                let data;
                
                // Try direct Binance API first
                try {
                    const binanceUrl = `${CONFIG.BINANCE_API}/klines?symbol=${crypto}&interval=${interval}&startTime=${startTime}&endTime=${endTime}&limit=1000`;
                    console.log('üì• Trying direct Binance API...');
                    
                    const response = await fetch(binanceUrl);
                    if (response.ok) {
                        data = await response.json();
                        console.log('‚úÖ Direct API success');
                    } else {
                        throw new Error('Direct API failed');
                    }
                } catch (error) {
                    console.log('‚ö†Ô∏è Direct API failed, trying CORS proxy...');
                    
                    // Try with CORS proxy
                    try {
                        const proxyUrl = `${CONFIG.CORS_PROXY}${encodeURIComponent(CONFIG.BINANCE_API + '/klines?symbol=' + crypto + '&interval=' + interval + '&startTime=' + startTime + '&endTime=' + endTime + '&limit=1000')}`;
                        
                        const response = await fetch(proxyUrl);
                        if (response.ok) {
                            data = await response.json();
                            console.log('‚úÖ CORS proxy success');
                        } else {
                            throw new Error('CORS proxy failed');
                        }
                    } catch (proxyError) {
                        console.log('‚ö†Ô∏è CORS proxy failed, generating realistic data...');
                        // Generate realistic data based on current crypto prices
                        data = generateRealisticData(crypto, interval, startTime, endTime);
                    }
                }
                
                // Formater les donn√©es
                state.historicalData = data.map(candle => ({
                    timestamp: candle[0],
                    time: new Date(candle[0]).toLocaleString('fr-FR'),
                    open: parseFloat(candle[1]),
                    high: parseFloat(candle[2]),
                    low: parseFloat(candle[3]),
                    close: parseFloat(candle[4]),
                    volume: parseFloat(candle[5])
                }));
                
                console.log('‚úÖ Loaded', state.historicalData.length, 'data points');
                
                // Determine data source
                const dataSource = data.length > 0 && typeof data[0][0] === 'number' ? 
                    (data.length === state.historicalData.length ? 'üìä Donn√©es r√©elles Binance' : 'üé≤ Donn√©es simul√©es r√©alistes') :
                    'üé≤ Donn√©es simul√©es r√©alistes';
                
                // Afficher les statistiques
                const prices = state.historicalData.map(d => d.close);
                const minPrice = Math.min(...prices);
                const maxPrice = Math.max(...prices);
                
                document.getElementById('dataPoints').textContent = state.historicalData.length;
                document.getElementById('dataPeriod').textContent = dataSource;
                document.getElementById('dataMin').textContent = '$' + minPrice.toFixed(2);
                document.getElementById('dataMax').textContent = '$' + maxPrice.toFixed(2);
                
                document.getElementById('loadingStatus').style.display = 'none';
                document.getElementById('dataStatus').style.display = 'grid';
                document.getElementById('startBtn').disabled = false;
                
                // Mettre √† jour le graphique
                updateChartWithHistoricalData();
                
                addLog('system', '‚úÖ DONN√âES', `${state.historicalData.length} points ‚Ä¢ ${dataSource} ‚Ä¢ ${crypto} ${interval}`);
                
            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                alert('‚ùå Erreur: ' + error.message);
                document.getElementById('loadingStatus').style.display = 'none';
                document.getElementById('loadBtn').disabled = false;
            }
        }

        function updateChartWithHistoricalData() {
            if (!priceChart || state.historicalData.length === 0) return;
            
            // Limiter √† 200 points pour la lisibilit√©
            const step = Math.max(1, Math.floor(state.historicalData.length / 200));
            const filteredData = state.historicalData.filter((_, i) => i % step === 0);
            
            priceChart.data.labels = filteredData.map(d => new Date(d.timestamp).toLocaleString('fr-FR', { 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }));
            priceChart.data.datasets[0].data = filteredData.map(d => d.close);
            priceChart.update();
        }

        // ============= AI SELECTION =============
        function toggleAI(aiName) {
            state.activeAIs[aiName] = !state.activeAIs[aiName];
            
            const card = document.getElementById(`card-${aiName}`);
            const checkbox = document.getElementById(`ai-${aiName}`);
            
            if (state.activeAIs[aiName]) {
                card.classList.add('active');
                checkbox.checked = true;
            } else {
                card.classList.remove('active');
                checkbox.checked = false;
            }
        }

        // ============= BACKTESTING =============
        async function startBacktest() {
            const activeCount = Object.values(state.activeAIs).filter(v => v).length;
            
            if (activeCount === 0) {
                alert('‚ùå S√©lectionnez au moins une IA');
                return;
            }
            
            if (state.historicalData.length === 0) {
                alert('‚ùå Chargez d\'abord les donn√©es historiques');
                return;
            }
            
            // Reset stats
            for (const ai in state.aiStats) {
                state.aiStats[ai] = { 
                    trades: 0, 
                    profit: 0, 
                    wins: 0, 
                    losses: 0, 
                    capital: state.initialCapital,
                    trades_detail: []
                };
            }
            state.positions = { claude: null, gemini: null, chatgpt: null, grok: null };
            state.tradeLogs = [];
            state.currentIndex = 0;
            
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('startBtn').disabled = true;
            document.getElementById('loadBtn').disabled = true;
            
            addLog('system', 'üî¨ BACKTEST', `D√©but - ${activeCount} IA actives`);
            
            state.backtestRunning = true;
            
            // Ex√©cuter le backtest
            await runBacktest();
            
            state.backtestRunning = false;
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('loadBtn').disabled = false;
            
            addLog('system', '‚úÖ TERMIN√â', 'Backtest compl√©t√©');
            
            // Afficher les r√©sultats
            updateLeaderboard();
            displayDetailedStats();
        }

        async function runBacktest() {
            const totalPoints = state.historicalData.length;
            const minPeriod = 50; // Minimum de donn√©es pour calculer les indicateurs
            
            for (let i = minPeriod; i < totalPoints; i++) {
                state.currentIndex = i;
                
                // Obtenir les donn√©es jusqu'√† ce point
                const historicalSlice = state.historicalData.slice(0, i + 1);
                const currentData = state.historicalData[i];
                
                // Mettre √† jour la progression
                const progress = ((i - minPeriod) / (totalPoints - minPeriod)) * 100;
                document.getElementById('progressBar').style.width = progress.toFixed(1) + '%';
                document.getElementById('progressPercent').textContent = progress.toFixed(1) + '%';
                document.getElementById('currentPoint').textContent = `${i + 1} / ${totalPoints}`;
                document.getElementById('currentTime').textContent = currentData.time;
                document.getElementById('currentPrice').textContent = '$' + currentData.close.toFixed(2);
                
                let totalTrades = 0;
                for (const ai in state.aiStats) {
                    totalTrades += state.aiStats[ai].trades;
                }
                document.getElementById('totalTrades').textContent = totalTrades;
                
                // Analyser et trader pour chaque IA active
                for (const [aiName, isActive] of Object.entries(state.activeAIs)) {
                    if (!isActive) continue;
                    
                    analyzeAndTrade(aiName, historicalSlice, currentData);
                }
                
                // Petite pause pour voir la progression (enlever en production)
                if (i % 10 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 1));
                }
            }
            
            // Cl√¥turer les positions ouvertes √† la fin
            for (const [aiName, isActive] of Object.entries(state.activeAIs)) {
                if (!isActive) continue;
                
                if (state.positions[aiName]) {
                    const lastData = state.historicalData[state.historicalData.length - 1];
                    closeFinalPosition(aiName, lastData);
                }
            }
        }

        function analyzeAndTrade(aiName, historicalSlice, currentData) {
            const prices = historicalSlice.map(d => d.close);
            const currentPrice = currentData.close;
            
            // V√©rifier s'il faut acheter
            if (!state.positions[aiName] && shouldBuy(aiName, prices, currentPrice)) {
                executeBuy(aiName, currentData);
            }
            // V√©rifier s'il faut vendre
            else if (state.positions[aiName] && shouldSell(aiName, state.positions[aiName], currentData)) {
                executeSell(aiName, currentData);
            }
        }

        // ============= INDICATEURS TECHNIQUES =============
        function calculateRSI(prices, period = 14) {
            if (prices.length < period + 1) return 50;
            
            let gains = 0, losses = 0;
            
            for (let i = prices.length - period; i < prices.length; i++) {
                const change = prices[i] - prices[i - 1];
                if (change > 0) gains += change;
                else losses += Math.abs(change);
            }
            
            const avgGain = gains / period;
            const avgLoss = losses / period;
            
            if (avgLoss === 0) return 100;
            return 100 - (100 / (1 + (avgGain / avgLoss)));
        }

        function calculateEMA(prices, period) {
            if (prices.length < period) return prices[prices.length - 1];
            
            const k = 2 / (period + 1);
            let ema = prices[0];
            
            for (let i = 1; i < prices.length; i++) {
                ema = prices[i] * k + ema * (1 - k);
            }
            
            return ema;
        }

        function calculateMomentum(prices, period = 10) {
            if (prices.length < period) return 0;
            return (prices[prices.length - 1] - prices[prices.length - period]) / prices[prices.length - period];
        }

        // ============= STRAT√âGIES D'ACHAT =============
        function shouldBuy(aiName, prices, currentPrice) {
            if (prices.length < 50) return false;
            
            const rsi = calculateRSI(prices);
            const ema20 = calculateEMA(prices, 20);
            const ema50 = calculateEMA(prices, 50);
            const momentum = calculateMomentum(prices);
            
            switch(aiName) {
                case 'claude':
                    // Conservateur: RSI tr√®s bas + EMA bullish
                    return rsi < 30 && ema20 > ema50 && currentPrice > ema20;
                    
                case 'gemini':
                    // √âquilibr√©: RSI moyen + momentum positif
                    return rsi < 35 && momentum > 0.01 && currentPrice > ema20;
                    
                case 'chatgpt':
                    // Momentum: EMA cross + momentum fort
                    return ema20 > ema50 && momentum > 0.015 && rsi < 70;
                    
                case 'grok':
                    // Agressif: momentum tr√®s fort
                    return momentum > 0.02 && rsi < 60;
                    
                default:
                    return false;
            }
        }

        function shouldSell(aiName, position, currentData) {
            if (!position) return false;
            
            const currentPrice = currentData.close;
            const profitPercent = ((currentPrice - position.entryPrice) / position.entryPrice) * 100;
            
            const strategies = {
                claude: { takeProfit: 2, stopLoss: -1 },
                gemini: { takeProfit: 3, stopLoss: -1.5 },
                chatgpt: { takeProfit: 4, stopLoss: -2 },
                grok: { takeProfit: 5, stopLoss: -2.5 }
            };
            
            const strategy = strategies[aiName];
            
            return profitPercent >= strategy.takeProfit || profitPercent <= strategy.stopLoss;
        }

        // ============= EX√âCUTION DES TRADES =============
        function executeBuy(aiName, currentData) {
            const stats = state.aiStats[aiName];
            
            // Montant du trade (30% du capital)
            const tradeAmount = stats.capital * 0.3;
            
            if (tradeAmount < 10) {
                return; // Montant trop faible
            }
            
            // Appliquer slippage et frais
            const slippageCost = tradeAmount * (state.slippage / 100);
            const fees = tradeAmount * (state.fees / 100);
            const totalCost = tradeAmount + slippageCost + fees;
            
            if (totalCost > stats.capital) {
                return; // Pas assez de capital
            }
            
            const tokensAmount = tradeAmount / currentData.close;
            
            state.positions[aiName] = {
                entryPrice: currentData.close,
                amount: tradeAmount,
                tokensAmount: tokensAmount,
                entryTime: currentData.timestamp,
                entryTimeStr: currentData.time
            };
            
            stats.capital -= totalCost;
            stats.trades++;
            
            addLog(aiName, 'üü¢ BUY', `${tokensAmount.toFixed(6)} @ $${currentData.close.toFixed(2)} ‚Ä¢ ${currentData.time}`);
        }

        function executeSell(aiName, currentData) {
            const position = state.positions[aiName];
            if (!position) return;
            
            const stats = state.aiStats[aiName];
            const sellValue = position.tokensAmount * currentData.close;
            
            // Appliquer slippage et frais
            const slippageCost = sellValue * (state.slippage / 100);
            const fees = sellValue * (state.fees / 100);
            const netValue = sellValue - slippageCost - fees;
            
            const profit = netValue - position.amount;
            const profitPercent = (profit / position.amount) * 100;
            
            stats.capital += netValue;
            stats.profit += profit;
            
            if (profit > 0) {
                stats.wins++;
            } else {
                stats.losses++;
            }
            
            stats.trades_detail.push({
                entry: position.entryPrice,
                exit: currentData.close,
                profit: profit,
                profitPercent: profitPercent,
                entryTime: position.entryTimeStr,
                exitTime: currentData.time
            });
            
            addLog(aiName, profit >= 0 ? 'üü¢ SELL' : 'üî¥ SELL', 
                `$${netValue.toFixed(2)} ‚Ä¢ Profit: ${profit >= 0 ? '+' : ''}$${profit.toFixed(2)} (${profitPercent >= 0 ? '+' : ''}${profitPercent.toFixed(2)}%) ‚Ä¢ ${currentData.time}`);
            
            state.positions[aiName] = null;
            
            updateAIStats(aiName);
        }

        function closeFinalPosition(aiName, lastData) {
            const position = state.positions[aiName];
            if (!position) return;
            
            addLog(aiName, '‚èπÔ∏è CLOSE', 'Cl√¥ture position finale');
            executeSell(aiName, lastData);
        }

        function updateAIStats(aiName) {
            const stats = state.aiStats[aiName];
            const totalProfit = stats.capital - state.initialCapital;
            const winRate = stats.trades > 0 ? ((stats.wins / stats.trades) * 100).toFixed(1) : 0;
            
            document.getElementById(`${aiName}-trades`).textContent = stats.trades;
            document.getElementById(`${aiName}-profit`).textContent = 
                (totalProfit >= 0 ? '+$' : '-$') + Math.abs(totalProfit).toFixed(2);
            document.getElementById(`${aiName}-winrate`).textContent = winRate + '%';
            
            const profitEl = document.getElementById(`${aiName}-profit`);
            profitEl.className = totalProfit >= 0 ? 'font-bold text-green-400' : 'font-bold text-red-400';
        }

        function updateLeaderboard() {
            const sorted = Object.entries(state.aiStats)
                .filter(([name]) => state.activeAIs[name])
                .map(([name, stats]) => ({
                    name,
                    stats,
                    totalProfit: stats.capital - state.initialCapital,
                    roi: ((stats.capital - state.initialCapital) / state.initialCapital) * 100
                }))
                .sort((a, b) => b.totalProfit - a.totalProfit);
            
            const icons = { claude: 'üß†', gemini: 'üíé', chatgpt: 'üöÄ', grok: '‚ö°' };
            
            const html = sorted.map((item, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üîπ';
                const winRate = item.stats.trades > 0 ? ((item.stats.wins / item.stats.trades) * 100).toFixed(1) : 0;
                
                return `
                    <div class="bg-gray-800 bg-opacity-50 border border-gray-600 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">${medal}</span>
                                <span class="text-xl">${icons[item.name]}</span>
                                <span class="font-bold">${item.name.toUpperCase()}</span>
                            </div>
                            <span class="text-xl font-bold ${item.totalProfit >= 0 ? 'text-green-400' : 'text-red-400'}">
                                ${item.totalProfit >= 0 ? '+' : ''}$${item.totalProfit.toFixed(2)}
                            </span>
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-xs text-gray-400 mb-2">
                            <div>Trades: <span class="text-white font-bold">${item.stats.trades}</span></div>
                            <div>Wins: <span class="text-green-400 font-bold">${item.stats.wins}</span></div>
                            <div>WR: <span class="font-bold">${winRate}%</span></div>
                        </div>
                        <div class="text-xs">
                            <span class="text-gray-400">ROI: </span>
                            <span class="font-bold ${item.roi >= 0 ? 'text-green-400' : 'text-red-400'}">
                                ${item.roi >= 0 ? '+' : ''}${item.roi.toFixed(2)}%
                            </span>
                            <span class="text-gray-400 ml-3">Capital final: </span>
                            <span class="font-bold text-white">${item.stats.capital.toFixed(2)} USDT</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('leaderboard').innerHTML = html || '<div class="text-center text-gray-500 py-8">No active AI</div>';
        }

        function displayDetailedStats() {
            const activeAIs = Object.entries(state.aiStats)
                .filter(([name]) => state.activeAIs[name]);
            
            const html = activeAIs.map(([name, stats]) => {
                const totalProfit = stats.capital - state.initialCapital;
                const roi = ((stats.capital - state.initialCapital) / state.initialCapital) * 100;
                const winRate = stats.trades > 0 ? ((stats.wins / stats.trades) * 100).toFixed(1) : 0;
                const avgWin = stats.wins > 0 ? (stats.trades_detail.filter(t => t.profit > 0).reduce((sum, t) => sum + t.profit, 0) / stats.wins) : 0;
                const avgLoss = stats.losses > 0 ? (stats.trades_detail.filter(t => t.profit < 0).reduce((sum, t) => sum + t.profit, 0) / stats.losses) : 0;
                const maxWin = stats.trades_detail.length > 0 ? Math.max(...stats.trades_detail.map(t => t.profit)) : 0;
                const maxLoss = stats.trades_detail.length > 0 ? Math.min(...stats.trades_detail.map(t => t.profit)) : 0;
                
                const icons = { claude: 'üß†', gemini: 'üíé', chatgpt: 'üöÄ', grok: '‚ö°' };
                
                return `
                    <div class="bg-gray-800 bg-opacity-50 border border-gray-600 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-2xl">${icons[name]}</span>
                            <h3 class="font-bold text-lg">${name.toUpperCase()}</h3>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">ROI:</span>
                                <span class="font-bold ${roi >= 0 ? 'text-green-400' : 'text-red-400'}">${roi >= 0 ? '+' : ''}${roi.toFixed(2)}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Profit total:</span>
                                <span class="font-bold ${totalProfit >= 0 ? 'text-green-400' : 'text-red-400'}">${totalProfit >= 0 ? '+' : ''}$${totalProfit.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Win rate:</span>
                                <span class="font-bold text-white">${winRate}%</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Avg win:</span>
                                <span class="font-bold text-green-400">+$${avgWin.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Avg loss:</span>
                                <span class="font-bold text-red-400">${avgLoss.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Best trade:</span>
                                <span class="font-bold text-green-400">+$${maxWin.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Worst trade:</span>
                                <span class="font-bold text-red-400">${maxLoss.toFixed(2)}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">Capital final:</span>
                                <span class="font-bold text-white">${stats.capital.toFixed(2)} USDT</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('detailedStats').innerHTML = html || 
                '<div class="col-span-4 text-center text-gray-500 py-8">Aucune statistique disponible</div>';
        }

        function addLog(source, action, details) {
            const timestamp = new Date(state.historicalData[state.currentIndex]?.timestamp || Date.now()).toLocaleTimeString();
            
            state.tradeLogs.unshift({ timestamp, source, action, details });
            if (state.tradeLogs.length > 200) state.tradeLogs.pop();
            
            // Render logs only every 10 trades to improve performance
            if (state.tradeLogs.length % 10 === 0 || action.includes('DONN√âES') || action.includes('TERMIN√â')) {
                renderLogs();
            }
        }

        function renderLogs() {
            const icons = { 
                claude: 'üß†', 
                gemini: 'üíé', 
                chatgpt: 'üöÄ',
                grok: '‚ö°',
                system: '‚öôÔ∏è'
            };
            
            // Limiter √† 50 logs affich√©s pour la performance
            const displayLogs = state.tradeLogs.slice(0, 50);
            
            const html = displayLogs.map(log => `
                <div class="bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg p-3">
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">${icons[log.source] || 'üìä'}</span>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-white">${log.source.toUpperCase()}</span>
                                <span class="text-xs text-gray-500">${log.timestamp}</span>
                            </div>
                            <p class="text-sm font-semibold mb-1 text-gray-300">${log.action}</p>
                            <p class="text-xs text-gray-400">${log.details}</p>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('tradeLogs').innerHTML = html || 
                '<div class="text-center text-gray-500 py-8">En attente de backtest...</div>';
        }

        function clearLogs() {
            if (confirm('Effacer tous les logs ?')) {
                state.tradeLogs = [];
                renderLogs();
            }
        }

        console.log('üî¨ BACKTESTING BOT READY');
    </script>
</body>
</html>
