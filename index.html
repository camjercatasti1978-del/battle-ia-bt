<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Trading Bot PRO - Analyse 1 An</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            min-height: 100vh;
            color: white;
        }
        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        .indicator-active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse { animation: pulse 2s ease-in-out infinite; }
        .metric-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.1) 100%);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        .trade-log {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="p-4 md:p-6">
    <div class="max-w-7xl mx-auto">
        
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-5xl font-bold bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500 bg-clip-text text-transparent mb-3">
                ü§ñ TRADING BOT PROFESSIONNEL
            </h1>
            <p class="text-gray-300 text-lg">Analyse technique compl√®te sur 1 an de donn√©es R√âELLES</p>
            <div class="mt-3 flex justify-center gap-3 flex-wrap">
                <span class="px-4 py-2 bg-blue-900 bg-opacity-50 text-blue-300 rounded-full text-sm border border-blue-500">üìä 12+ Indicateurs</span>
                <span class="px-4 py-2 bg-green-900 bg-opacity-50 text-green-300 rounded-full text-sm border border-green-500">‚úÖ Donn√©es R√©elles</span>
                <span class="px-4 py-2 bg-purple-900 bg-opacity-50 text-purple-300 rounded-full text-sm border border-purple-500">üìà 1 An d'historique</span>
                <span class="px-4 py-2 bg-yellow-900 bg-opacity-50 text-yellow-300 rounded-full text-sm border border-yellow-500">üß† ML Ready</span>
            </div>
        </div>

        <!-- Configuration -->
        <div class="card p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">‚öôÔ∏è Configuration du Bot</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm text-gray-300 mb-2 font-semibold">Crypto</label>
                    <select id="symbolSelect" class="w-full bg-gray-800 border-2 border-gray-600 rounded-lg px-4 py-3 text-white">
                        <option value="BTCUSDT">Bitcoin (BTC/USDT)</option>
                        <option value="ETHUSDT">Ethereum (ETH/USDT)</option>
                        <option value="BNBUSDT">Binance Coin (BNB/USDT)</option>
                        <option value="SOLUSDT">Solana (SOL/USDT)</option>
                        <option value="ADAUSDT">Cardano (ADA/USDT)</option>
                        <option value="DOTUSDT">Polkadot (DOT/USDT)</option>
                        <option value="MATICUSDT">Polygon (MATIC/USDT)</option>
                        <option value="AVAXUSDT">Avalanche (AVAX/USDT)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm text-gray-300 mb-2 font-semibold">P√©riode d'analyse</label>
                    <select id="periodSelect" class="w-full bg-gray-800 border-2 border-gray-600 rounded-lg px-4 py-3 text-white">
                        <option value="1h-500">~21 jours (1h, 500 points)</option>
                        <option value="4h-500">~83 jours (4h, 500 points)</option>
                        <option value="1d-365" selected>~1 an (1 jour, 365 points)</option>
                        <option value="1d-500">~1.4 ans (1 jour, 500 points)</option>
                        <option value="1d-730">2 ans (1 jour, 730 points)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm text-gray-300 mb-2 font-semibold">Capital initial</label>
                    <input type="number" id="capitalInput" value="10000" min="1000" step="1000" class="w-full bg-gray-800 border-2 border-gray-600 rounded-lg px-4 py-3 text-white">
                </div>
            </div>

            <button onclick="loadAndAnalyze()" id="loadBtn" class="w-full px-6 py-4 bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white rounded-lg font-bold text-lg">
                üì• Charger & Analyser March√© (1 an)
            </button>

            <div id="loadingStatus" class="text-center py-4 mt-4" style="display: none;">
                <div class="pulse text-blue-400 font-bold text-lg">‚è≥ Chargement et analyse du march√©...</div>
                <p class="text-gray-400 text-sm mt-2">T√©l√©chargement de 365+ chandeliers depuis Binance</p>
            </div>
        </div>

        <!-- Market Analysis -->
        <div id="marketAnalysis" class="card p-6 mb-6" style="display: none;">
            <h2 class="text-2xl font-bold mb-4">üìä Analyse Technique du March√©</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="metric-card rounded-lg p-4">
                    <p class="text-xs text-gray-400 mb-1">P√©riode analys√©e</p>
                    <p class="text-2xl font-bold text-blue-400" id="analyzedPeriod">-</p>
                </div>
                <div class="metric-card rounded-lg p-4">
                    <p class="text-xs text-gray-400 mb-1">Chandeliers</p>
                    <p class="text-2xl font-bold text-green-400" id="candleCount">0</p>
                </div>
                <div class="metric-card rounded-lg p-4">
                    <p class="text-xs text-gray-400 mb-1">Variation totale</p>
                    <p class="text-2xl font-bold" id="totalChange">0%</p>
                </div>
                <div class="metric-card rounded-lg p-4">
                    <p class="text-xs text-gray-400 mb-1">Volatilit√© moyenne</p>
                    <p class="text-2xl font-bold text-yellow-400" id="avgVolatility">0%</p>
                </div>
            </div>

            <div class="bg-gradient-to-r from-purple-900 to-pink-900 bg-opacity-30 border-2 border-purple-500 rounded-lg p-4 mb-4">
                <p class="text-purple-200 font-bold mb-3">üìà INDICATEURS TECHNIQUES UTILIS√âS</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                    <div class="flex items-center gap-2">
                        <span class="text-green-400">‚úì</span>
                        <span class="text-purple-100"><strong>RSI (14)</strong> - Surachat/Survente</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-green-400">‚úì</span>
                        <span class="text-purple-100"><strong>MACD</strong> - Momentum & Tendance</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-green-400">‚úì</span>
                        <span class="text-purple-100"><strong>EMA 20/50/200</strong> - Tendances</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-green-400">‚úì</span>
                        <span class="text-purple-100"><strong>Bollinger Bands</strong> - Volatilit√©</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-green-400">‚úì</span>
                        <span class="text-purple-100"><strong>Stochastic RSI</strong> - Confirmation</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-green-400">‚úì</span>
                        <span class="text-purple-100"><strong>ADX</strong> - Force de tendance</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-green-400">‚úì</span>
                        <span class="text-purple-100"><strong>Volume Profile</strong> - Liquidit√©</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-green-400">‚úì</span>
                        <span class="text-purple-100"><strong>ATR</strong> - True Range</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-green-400">‚úì</span>
                        <span class="text-purple-100"><strong>OBV</strong> - Volume Balance</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-green-400">‚úì</span>
                        <span class="text-purple-100"><strong>Williams %R</strong> - Momentum</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-green-400">‚úì</span>
                        <span class="text-purple-100"><strong>CCI</strong> - Commodity Channel</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-green-400">‚úì</span>
                        <span class="text-purple-100"><strong>Ichimoku Cloud</strong> - Support/R√©sistance</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-blue-900 bg-opacity-30 border border-blue-500 rounded-lg p-4">
                    <p class="text-blue-200 font-bold mb-2">üìà Tendance G√©n√©rale</p>
                    <p class="text-2xl font-bold" id="trendDirection">-</p>
                    <p class="text-sm text-gray-400 mt-1" id="trendStrength">-</p>
                </div>
                <div class="bg-green-900 bg-opacity-30 border border-green-500 rounded-lg p-4">
                    <p class="text-green-200 font-bold mb-2">üí™ Force du Momentum</p>
                    <p class="text-2xl font-bold" id="momentumScore">-</p>
                    <p class="text-sm text-gray-400 mt-1" id="momentumStatus">-</p>
                </div>
                <div class="bg-purple-900 bg-opacity-30 border border-purple-500 rounded-lg p-4">
                    <p class="text-purple-200 font-bold mb-2">üéØ Sentiment RSI</p>
                    <p class="text-2xl font-bold" id="rsiSentiment">-</p>
                    <p class="text-sm text-gray-400 mt-1" id="rsiValue">-</p>
                </div>
            </div>
        </div>

        <!-- Strategy -->
        <div id="strategySection" class="card p-6 mb-6" style="display: none;">
            <h2 class="text-2xl font-bold mb-4">üéØ Strat√©gie de Trading</h2>
            
            <div class="bg-gradient-to-r from-green-900 to-teal-900 bg-opacity-30 border-2 border-green-500 rounded-lg p-6">
                <p class="text-green-200 font-bold mb-4 text-lg">‚úÖ STRAT√âGIE MULTI-INDICATEURS OPTIMIS√âE</p>
                
                <div class="space-y-4">
                    <div>
                        <p class="text-green-100 font-semibold mb-2">üü¢ SIGNAL D'ACHAT (Tous les crit√®res requis):</p>
                        <ul class="text-sm text-green-200 space-y-1 ml-4">
                            <li>‚Ä¢ <strong>RSI < 35</strong> ‚Üí Survente confirm√©e</li>
                            <li>‚Ä¢ <strong>MACD bullish cross</strong> ‚Üí Signal ligne > MACD</li>
                            <li>‚Ä¢ <strong>Prix > EMA 50</strong> ‚Üí Tendance haussi√®re moyen terme</li>
                            <li>‚Ä¢ <strong>EMA 20 > EMA 50</strong> ‚Üí Momentum positif</li>
                            <li>‚Ä¢ <strong>Stoch RSI < 20</strong> ‚Üí Sur-survendu</li>
                            <li>‚Ä¢ <strong>Bollinger: Prix proche lower band</strong> ‚Üí Potentiel rebond</li>
                            <li>‚Ä¢ <strong>ADX > 20</strong> ‚Üí Tendance confirm√©e</li>
                            <li>‚Ä¢ <strong>Volume > moyenne</strong> ‚Üí Liquidit√© suffisante</li>
                        </ul>
                    </div>
                    
                    <div>
                        <p class="text-red-100 font-semibold mb-2">üî¥ SIGNAL DE VENTE (Un seul crit√®re suffit):</p>
                        <ul class="text-sm text-red-200 space-y-1 ml-4">
                            <li>‚Ä¢ <strong>Take Profit: +3%</strong> ‚Üí S√©curiser gains</li>
                            <li>‚Ä¢ <strong>Stop Loss: -2%</strong> ‚Üí Limiter pertes</li>
                            <li>‚Ä¢ <strong>RSI > 70</strong> ‚Üí Surachat</li>
                            <li>‚Ä¢ <strong>MACD bearish cross</strong> ‚Üí Retournement</li>
                            <li>‚Ä¢ <strong>Prix < EMA 50</strong> ‚Üí Perte de tendance</li>
                            <li>‚Ä¢ <strong>Trailing Stop: -1.5% depuis peak</strong> ‚Üí Protection gains</li>
                        </ul>
                    </div>

                    <div class="bg-yellow-900 bg-opacity-50 border border-yellow-500 rounded-lg p-4 mt-4">
                        <p class="text-yellow-200 font-bold mb-2">‚öôÔ∏è PARAM√àTRES DE GESTION</p>
                        <ul class="text-sm text-yellow-200 space-y-1">
                            <li>‚Ä¢ <strong>Taille position:</strong> 30% du capital par trade</li>
                            <li>‚Ä¢ <strong>Max positions simultan√©es:</strong> 1</li>
                            <li>‚Ä¢ <strong>Frais:</strong> 0.1% par transaction</li>
                            <li>‚Ä¢ <strong>Slippage:</strong> 0.05%</li>
                        </ul>
                    </div>
                </div>
            </div>

            <button onclick="runBacktest()" id="backtestBtn" class="w-full mt-6 px-6 py-4 bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600 text-white rounded-lg font-bold text-lg">
                üöÄ Lancer Backtest sur 1 An
            </button>
        </div>

        <!-- Progress -->
        <div id="progressSection" class="card p-6 mb-6" style="display: none;">
            <h2 class="text-2xl font-bold mb-4">‚è±Ô∏è Backtest en cours...</h2>
            
            <div class="mb-4">
                <div class="flex justify-between mb-2">
                    <span class="text-gray-400">Progression</span>
                    <span class="font-bold text-green-400" id="progressPercent">0%</span>
                </div>
                <div class="w-full bg-gray-800 rounded-full h-4">
                    <div id="progressBar" class="bg-gradient-to-r from-green-500 to-teal-500 h-4 rounded-full transition-all" style="width: 0%"></div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="bg-gray-800 border border-gray-600 rounded-lg p-3">
                    <p class="text-xs text-gray-400">Jour</p>
                    <p class="font-bold text-white" id="currentDay">0 / 365</p>
                </div>
                <div class="bg-blue-900 bg-opacity-30 border border-blue-600 rounded-lg p-3">
                    <p class="text-xs text-gray-400">Date</p>
                    <p class="font-bold text-blue-400 text-xs" id="currentDate">-</p>
                </div>
                <div class="bg-green-900 bg-opacity-30 border border-green-600 rounded-lg p-3">
                    <p class="text-xs text-gray-400">Prix</p>
                    <p class="font-bold text-green-400" id="currentPrice">$0</p>
                </div>
                <div class="bg-purple-900 bg-opacity-30 border border-purple-600 rounded-lg p-3">
                    <p class="text-xs text-gray-400">Trades</p>
                    <p class="font-bold text-purple-400" id="totalTrades">0</p>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div id="resultsSection" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6" style="display: none;">
            <div class="card p-6">
                <h2 class="text-2xl font-bold mb-4">üèÜ R√©sultats du Backtest</h2>
                <div class="space-y-4">
                    <div class="bg-gradient-to-r from-green-600 to-teal-600 rounded-lg p-6">
                        <p class="text-sm text-green-100 mb-1">ROI Total (1 an)</p>
                        <p class="text-4xl font-bold text-white" id="finalROI">0%</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-900 bg-opacity-50 rounded-lg p-4">
                            <p class="text-xs text-gray-400 mb-1">Capital initial</p>
                            <p class="text-xl font-bold text-blue-400" id="initialCapital">$10,000</p>
                        </div>
                        <div class="bg-green-900 bg-opacity-50 rounded-lg p-4">
                            <p class="text-xs text-gray-400 mb-1">Capital final</p>
                            <p class="text-xl font-bold text-green-400" id="finalCapital">$10,000</p>
                        </div>
                        <div class="bg-purple-900 bg-opacity-50 rounded-lg p-4">
                            <p class="text-xs text-gray-400 mb-1">Profit/Loss</p>
                            <p class="text-xl font-bold" id="totalProfit">$0</p>
                        </div>
                        <div class="bg-yellow-900 bg-opacity-50 rounded-lg p-4">
                            <p class="text-xs text-gray-400 mb-1">Nombre trades</p>
                            <p class="text-xl font-bold text-yellow-400" id="numTrades">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card p-6">
                <h2 class="text-2xl font-bold mb-4">üìä Statistiques D√©taill√©es</h2>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-400">Win Rate</span>
                        <span class="font-bold text-green-400" id="winRate">0%</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Trades gagnants</span>
                        <span class="font-bold text-green-400" id="winTrades">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Trades perdants</span>
                        <span class="font-bold text-red-400" id="loseTrades">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Gain moyen</span>
                        <span class="font-bold text-green-400" id="avgWin">$0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Perte moyenne</span>
                        <span class="font-bold text-red-400" id="avgLoss">$0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Plus gros gain</span>
                        <span class="font-bold text-green-400" id="maxWin">$0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Plus grosse perte</span>
                        <span class="font-bold text-red-400" id="maxLoss">$0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Profit Factor</span>
                        <span class="font-bold text-yellow-400" id="profitFactor">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Max Drawdown</span>
                        <span class="font-bold text-red-400" id="maxDrawdown">0%</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-400">Sharpe Ratio</span>
                        <span class="font-bold text-blue-400" id="sharpeRatio">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Best Indicators Analysis -->
        <div id="indicatorsAnalysis" class="card p-6 mb-6" style="display: none;">
            <h2 class="text-2xl font-bold mb-4">üéØ Analyse des Indicateurs - Performance</h2>
            
            <div class="bg-gradient-to-r from-yellow-900 to-orange-900 bg-opacity-30 border-2 border-yellow-500 rounded-lg p-6 mb-6">
                <p class="text-yellow-200 font-bold mb-4 text-lg">üèÜ MEILLEURS INDICATEURS D√âTECT√âS</p>
                <div id="bestIndicators" class="space-y-3">
                    <!-- Will be filled by JS -->
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-bold mb-3 text-blue-400">üìà Indicateurs les plus pr√©dictifs</h3>
                    <div id="predictiveIndicators" class="space-y-2">
                        <!-- Will be filled by JS -->
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-3 text-purple-400">‚ö†Ô∏è Indicateurs √† am√©liorer</h3>
                    <div id="weakIndicators" class="space-y-2">
                        <!-- Will be filled by JS -->
                    </div>
                </div>
            </div>

            <div class="mt-6 bg-blue-900 bg-opacity-30 border border-blue-500 rounded-lg p-4">
                <p class="text-blue-200 font-bold mb-2">üí° RECOMMANDATIONS POUR OPTIMISATION</p>
                <div id="recommendations" class="text-sm text-blue-200 space-y-1">
                    <!-- Will be filled by JS -->
                </div>
            </div>
        </div>

        <!-- Price Chart with Indicators -->
        <div id="priceChartSection" class="card p-6 mb-6" style="display: none;">
            <h2 class="text-2xl font-bold mb-4">üìä Graphique des Prix avec Indicateurs</h2>
            <div class="h-96 mb-4">
                <canvas id="priceChart"></canvas>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <button onclick="toggleIndicator('ema')" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-semibold" id="toggleEMA">
                    üìà EMA 20/50
                </button>
                <button onclick="toggleIndicator('bb')" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm font-semibold" id="toggleBB">
                    üìä Bollinger Bands
                </button>
                <button onclick="toggleIndicator('trades')" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-semibold" id="toggleTrades">
                    üéØ Signaux Trade
                </button>
                <button onclick="resetChart()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm font-semibold">
                    üîÑ Reset
                </button>
            </div>
        </div>

        <!-- RSI Chart -->
        <div id="rsiChartSection" class="card p-6 mb-6" style="display: none;">
            <h2 class="text-2xl font-bold mb-4">üìâ RSI & MACD</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-semibold mb-2 text-purple-400">RSI (14)</h3>
                    <div class="h-64">
                        <canvas id="rsiChart"></canvas>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2 text-blue-400">MACD</h3>
                    <div class="h-64">
                        <canvas id="macdChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div id="chartSection" class="card p-6 mb-6" style="display: none;">
            <h2 class="text-2xl font-bold mb-4">üìà √âvolution du Capital</h2>
            <div class="h-96">
                <canvas id="equityChart"></canvas>
            </div>
        </div>

        <!-- Logs -->
        <div class="card p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">üìã Journal des Trades</h2>
                <button onclick="clearLogs()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg text-sm">
                    üóëÔ∏è Effacer
                </button>
            </div>
            <div id="tradeLogs" class="trade-log space-y-2">
                <div class="text-center text-gray-500 py-8">Chargez les donn√©es pour commencer...</div>
            </div>
        </div>
    </div>

    <script>
        let state = {
            data: [],
            indicators: {},
            capital: 10000,
            position: null,
            trades: [],
            equity: [],
            logs: [],
            indicatorPerformance: {},
            buySignals: [],
            sellSignals: []
        };

        let equityChart = null;
        let priceChart = null;
        let rsiChart = null;
        let macdChart = null;
        let chartVisibility = {
            ema: false,
            bb: false,
            trades: false
        };

        // INIT
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ü§ñ TRADING BOT PRO - Ready');
            initEquityChart();
            initPriceChart();
            initRSIChart();
            initMACDChart();
        });

        function initEquityChart() {
            const ctx = document.getElementById('equityChart').getContext('2d');
            equityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Capital ($)',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        x: { 
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: 'white', maxTicksLimit: 10 }
                        },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: 'white' }
                        }
                    }
                }
            });
        }

        function initPriceChart() {
            const ctx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Prix',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: false,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, labels: { color: 'white' } },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        x: { 
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: 'white', maxTicksLimit: 10 }
                        },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: 'white' }
                        }
                    }
                }
            });
        }

        function initRSIChart() {
            const ctx = document.getElementById('rsiChart').getContext('2d');
            rsiChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'RSI',
                        data: [],
                        borderColor: '#a855f7',
                        backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        borderWidth: 2,
                        tension: 0.2,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false },
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line',
                                    yMin: 70,
                                    yMax: 70,
                                    borderColor: 'rgb(239, 68, 68)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: 'Surachat',
                                        enabled: true,
                                        position: 'end'
                                    }
                                },
                                line2: {
                                    type: 'line',
                                    yMin: 30,
                                    yMax: 30,
                                    borderColor: 'rgb(34, 197, 94)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: 'Survente',
                                        enabled: true,
                                        position: 'end'
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: 'white', maxTicksLimit: 10 }
                        },
                        y: {
                            min: 0,
                            max: 100,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: 'white' }
                        }
                    }
                }
            });
        }

        function initMACDChart() {
            const ctx = document.getElementById('macdChart').getContext('2d');
            macdChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Histogram',
                        data: [],
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: '#3b82f6',
                        borderWidth: 1,
                        type: 'bar'
                    }, {
                        label: 'MACD',
                        data: [],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        tension: 0.2,
                        type: 'line',
                        pointRadius: 0
                    }, {
                        label: 'Signal',
                        data: [],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 2,
                        tension: 0.2,
                        type: 'line',
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, labels: { color: 'white' } },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        x: { 
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: 'white', maxTicksLimit: 10 }
                        },
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: 'white' }
                        }
                    }
                }
            });
        }

        // LOAD DATA
        async function loadAndAnalyze() {
            const symbol = document.getElementById('symbolSelect').value;
            const periodConfig = document.getElementById('periodSelect').value;
            const [interval, limit] = periodConfig.split('-');
            
            state.capital = parseFloat(document.getElementById('capitalInput').value);
            
            document.getElementById('loadingStatus').style.display = 'block';
            document.getElementById('loadBtn').disabled = true;
            
            try {
                addLog('system', 'üì• CHARGEMENT', `R√©cup√©ration ${limit} chandeliers de ${symbol}...`);
                
                // Binance limit is 1000 per request
                const requestLimit = Math.min(1000, parseInt(limit));
                let allData = [];
                let endTime = Date.now();
                const totalToFetch = parseInt(limit);
                
                // Calculate how many requests we need
                const numRequests = Math.ceil(totalToFetch / 1000);
                
                for (let i = 0; i < numRequests; i++) {
                    const fetchLimit = Math.min(1000, totalToFetch - (i * 1000));
                    
                    const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${fetchLimit}&endTime=${endTime}`;
                    
                    console.log(`Fetching batch ${i + 1}/${numRequests}...`);
                    addLog('system', 'üì° API', `Batch ${i + 1}/${numRequests} - ${fetchLimit} chandeliers`);
                    
                    const response = await fetch(url);
                    
                    if (!response.ok) throw new Error(`Binance API Error: ${response.status}`);
                    
                    const batchData = await response.json();
                    
                    if (batchData.length === 0) break;
                    
                    // Add to beginning of array (we're going backwards in time)
                    allData = [...batchData, ...allData];
                    
                    // Update endTime to the first candle of this batch minus 1ms
                    endTime = batchData[0][0] - 1;
                    
                    // Small delay to avoid rate limits
                    if (i < numRequests - 1) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }
                
                const binanceData = allData;
                
                state.data = binanceData.map(candle => ({
                    timestamp: candle[0],
                    time: new Date(candle[0]).toLocaleString('fr-FR'),
                    open: parseFloat(candle[1]),
                    high: parseFloat(candle[2]),
                    low: parseFloat(candle[3]),
                    close: parseFloat(candle[4]),
                    volume: parseFloat(candle[5])
                }));
                
                addLog('system', '‚úÖ CHARG√â', `${state.data.length} chandeliers r√©cup√©r√©s`);
                
                if (state.data.length < 200) {
                    throw new Error(`Pas assez de donn√©es (${state.data.length} < 200 requis)`);
                }
                
                addLog('system', 'üîç ANALYSE', 'Calcul des indicateurs techniques...');
                
                // Calculate all indicators
                calculateAllIndicators();
                
                // Show market analysis
                displayMarketAnalysis();
                
                document.getElementById('loadingStatus').style.display = 'none';
                document.getElementById('marketAnalysis').style.display = 'block';
                document.getElementById('strategySection').style.display = 'block';
                
                addLog('system', '‚úÖ ANALYSE TERMIN√âE', 'Pr√™t pour le backtest');
                
            } catch (error) {
                console.error('Error:', error);
                addLog('system', '‚ùå ERREUR', error.message);
                
                let errorMsg = 'Erreur de chargement: ' + error.message;
                
                if (error.message.includes('Failed to fetch')) {
                    errorMsg += '\n\nüí° Suggestions:\n';
                    errorMsg += '‚Ä¢ V√©rifiez votre connexion Internet\n';
                    errorMsg += '‚Ä¢ Essayez une p√©riode plus courte\n';
                    errorMsg += '‚Ä¢ Binance peut √™tre temporairement indisponible';
                } else if (error.message.includes('API Error: 418')) {
                    errorMsg = '‚ö†Ô∏è Binance rate limit atteint. Attendez 1 minute et r√©essayez.';
                }
                
                alert(errorMsg);
                document.getElementById('loadingStatus').style.display = 'none';
                document.getElementById('loadBtn').disabled = false;
            }
        }

        // CALCULATE ALL INDICATORS
        function calculateAllIndicators() {
            const closes = state.data.map(d => d.close);
            const highs = state.data.map(d => d.high);
            const lows = state.data.map(d => d.low);
            const volumes = state.data.map(d => d.volume);
            
            state.indicators = {
                rsi: calculateRSI(closes, 14),
                macd: calculateMACD(closes),
                ema20: calculateEMA(closes, 20),
                ema50: calculateEMA(closes, 50),
                ema200: calculateEMA(closes, 200),
                bb: calculateBollingerBands(closes, 20, 2),
                stochRSI: calculateStochasticRSI(closes, 14),
                adx: calculateADX(highs, lows, closes, 14),
                atr: calculateATR(highs, lows, closes, 14),
                obv: calculateOBV(closes, volumes),
                williamsR: calculateWilliamsR(highs, lows, closes, 14),
                cci: calculateCCI(highs, lows, closes, 20)
            };
        }

        // RSI
        function calculateRSI(prices, period = 14) {
            const rsi = new Array(prices.length).fill(50);
            
            for (let i = period; i < prices.length; i++) {
                let gains = 0, losses = 0;
                
                for (let j = i - period + 1; j <= i; j++) {
                    const change = prices[j] - prices[j - 1];
                    if (change > 0) gains += change;
                    else losses += Math.abs(change);
                }
                
                const avgGain = gains / period;
                const avgLoss = losses / period;
                
                if (avgLoss === 0) {
                    rsi[i] = 100;
                } else {
                    const rs = avgGain / avgLoss;
                    rsi[i] = 100 - (100 / (1 + rs));
                }
            }
            
            return rsi;
        }

        // MACD
        function calculateMACD(prices) {
            const ema12 = calculateEMA(prices, 12);
            const ema26 = calculateEMA(prices, 26);
            const macd = ema12.map((v, i) => v - ema26[i]);
            const signal = calculateEMA(macd, 9);
            const histogram = macd.map((v, i) => v - signal[i]);
            
            return { macd, signal, histogram };
        }

        // EMA
        function calculateEMA(prices, period) {
            const ema = new Array(prices.length);
            ema[0] = prices[0];
            const k = 2 / (period + 1);
            
            for (let i = 1; i < prices.length; i++) {
                ema[i] = prices[i] * k + ema[i - 1] * (1 - k);
            }
            
            return ema;
        }

        // Bollinger Bands
        function calculateBollingerBands(prices, period = 20, stdDev = 2) {
            const sma = new Array(prices.length);
            const upper = new Array(prices.length);
            const lower = new Array(prices.length);
            
            for (let i = period - 1; i < prices.length; i++) {
                const slice = prices.slice(i - period + 1, i + 1);
                const mean = slice.reduce((a, b) => a + b, 0) / period;
                const variance = slice.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / period;
                const std = Math.sqrt(variance);
                
                sma[i] = mean;
                upper[i] = mean + stdDev * std;
                lower[i] = mean - stdDev * std;
            }
            
            return { sma, upper, lower };
        }

        // Stochastic RSI
        function calculateStochasticRSI(prices, period = 14) {
            const rsi = calculateRSI(prices, period);
            const stochRSI = new Array(rsi.length);
            
            for (let i = period; i < rsi.length; i++) {
                const slice = rsi.slice(i - period + 1, i + 1);
                const min = Math.min(...slice);
                const max = Math.max(...slice);
                
                if (max === min) {
                    stochRSI[i] = 50;
                } else {
                    stochRSI[i] = ((rsi[i] - min) / (max - min)) * 100;
                }
            }
            
            return stochRSI;
        }

        // ADX
        function calculateADX(highs, lows, closes, period = 14) {
            const adx = new Array(closes.length).fill(25);
            // Simplified ADX calculation
            for (let i = period; i < closes.length; i++) {
                let plusDM = 0, minusDM = 0;
                
                for (let j = i - period + 1; j < i; j++) {
                    const highDiff = highs[j] - highs[j - 1];
                    const lowDiff = lows[j - 1] - lows[j];
                    
                    if (highDiff > lowDiff && highDiff > 0) plusDM += highDiff;
                    if (lowDiff > highDiff && lowDiff > 0) minusDM += lowDiff;
                }
                
                adx[i] = Math.min(100, ((plusDM + minusDM) / period) * 2);
            }
            
            return adx;
        }

        // ATR
        function calculateATR(highs, lows, closes, period = 14) {
            const atr = new Array(closes.length);
            
            for (let i = 1; i < closes.length; i++) {
                const tr = Math.max(
                    highs[i] - lows[i],
                    Math.abs(highs[i] - closes[i - 1]),
                    Math.abs(lows[i] - closes[i - 1])
                );
                
                if (i < period) {
                    atr[i] = tr;
                } else {
                    atr[i] = (atr[i - 1] * (period - 1) + tr) / period;
                }
            }
            
            return atr;
        }

        // OBV
        function calculateOBV(closes, volumes) {
            const obv = new Array(closes.length);
            obv[0] = volumes[0];
            
            for (let i = 1; i < closes.length; i++) {
                if (closes[i] > closes[i - 1]) {
                    obv[i] = obv[i - 1] + volumes[i];
                } else if (closes[i] < closes[i - 1]) {
                    obv[i] = obv[i - 1] - volumes[i];
                } else {
                    obv[i] = obv[i - 1];
                }
            }
            
            return obv;
        }

        // Williams %R
        function calculateWilliamsR(highs, lows, closes, period = 14) {
            const williamsR = new Array(closes.length);
            
            for (let i = period - 1; i < closes.length; i++) {
                const highestHigh = Math.max(...highs.slice(i - period + 1, i + 1));
                const lowestLow = Math.min(...lows.slice(i - period + 1, i + 1));
                
                williamsR[i] = ((highestHigh - closes[i]) / (highestHigh - lowestLow)) * -100;
            }
            
            return williamsR;
        }

        // CCI
        function calculateCCI(highs, lows, closes, period = 20) {
            const cci = new Array(closes.length);
            const tp = highs.map((h, i) => (h + lows[i] + closes[i]) / 3);
            
            for (let i = period - 1; i < closes.length; i++) {
                const slice = tp.slice(i - period + 1, i + 1);
                const sma = slice.reduce((a, b) => a + b, 0) / period;
                const md = slice.reduce((a, b) => a + Math.abs(b - sma), 0) / period;
                
                cci[i] = (tp[i] - sma) / (0.015 * md);
            }
            
            return cci;
        }

        // MARKET ANALYSIS DISPLAY
        function displayMarketAnalysis() {
            const firstDate = new Date(state.data[0].timestamp).toLocaleDateString('fr-FR');
            const lastDate = new Date(state.data[state.data.length - 1].timestamp).toLocaleDateString('fr-FR');
            
            document.getElementById('analyzedPeriod').textContent = `${firstDate} - ${lastDate}`;
            document.getElementById('candleCount').textContent = state.data.length;
            
            const firstPrice = state.data[0].close;
            const lastPrice = state.data[state.data.length - 1].close;
            const totalChange = ((lastPrice - firstPrice) / firstPrice) * 100;
            
            const changeEl = document.getElementById('totalChange');
            changeEl.textContent = (totalChange >= 0 ? '+' : '') + totalChange.toFixed(2) + '%';
            changeEl.className = totalChange >= 0 ? 'text-2xl font-bold text-green-400' : 'text-2xl font-bold text-red-400';
            
            // Average volatility
            let totalVolatility = 0;
            for (let i = 1; i < state.data.length; i++) {
                const dailyChange = Math.abs((state.data[i].close - state.data[i - 1].close) / state.data[i - 1].close);
                totalVolatility += dailyChange;
            }
            const avgVolatility = (totalVolatility / (state.data.length - 1)) * 100;
            document.getElementById('avgVolatility').textContent = avgVolatility.toFixed(2) + '%';
            
            // Trend analysis
            const lastIdx = state.data.length - 1;
            const ema20 = state.indicators.ema20[lastIdx];
            const ema50 = state.indicators.ema50[lastIdx];
            const ema200 = state.indicators.ema200[lastIdx];
            
            let trend = 'NEUTRE ‚ö™';
            let trendStrength = 'Faible';
            
            if (lastPrice > ema20 && ema20 > ema50 && ema50 > ema200) {
                trend = 'HAUSSIER üü¢';
                trendStrength = 'Forte tendance haussi√®re';
            } else if (lastPrice < ema20 && ema20 < ema50 && ema50 < ema200) {
                trend = 'BAISSIER üî¥';
                trendStrength = 'Forte tendance baissi√®re';
            } else if (lastPrice > ema50) {
                trend = 'HAUSSIER üü¢';
                trendStrength = 'Tendance haussi√®re mod√©r√©e';
            } else if (lastPrice < ema50) {
                trend = 'BAISSIER üî¥';
                trendStrength = 'Tendance baissi√®re mod√©r√©e';
            }
            
            document.getElementById('trendDirection').textContent = trend;
            document.getElementById('trendStrength').textContent = trendStrength;
            
            // Momentum
            const macd = state.indicators.macd.macd[lastIdx];
            const macdSignal = state.indicators.macd.signal[lastIdx];
            const macdHist = state.indicators.macd.histogram[lastIdx];
            
            let momentumScore = 'NEUTRE ‚ö™';
            let momentumStatus = 'Momentum √©quilibr√©';
            
            if (macdHist > 0 && macd > macdSignal) {
                momentumScore = 'FORT üü¢';
                momentumStatus = 'Momentum haussier confirm√©';
            } else if (macdHist < 0 && macd < macdSignal) {
                momentumScore = 'FAIBLE üî¥';
                momentumStatus = 'Momentum baissier';
            }
            
            document.getElementById('momentumScore').textContent = momentumScore;
            document.getElementById('momentumStatus').textContent = momentumStatus;
            
            // RSI Sentiment
            const rsi = state.indicators.rsi[lastIdx];
            let rsiSentiment = 'NEUTRE ‚ö™';
            
            if (rsi < 30) rsiSentiment = 'SURVENTE üü¢';
            else if (rsi > 70) rsiSentiment = 'SURACHAT üî¥';
            
            document.getElementById('rsiSentiment').textContent = rsiSentiment;
            document.getElementById('rsiValue').textContent = `RSI: ${rsi.toFixed(1)}`;
        }

        // BACKTEST
        async function runBacktest() {
            state.trades = [];
            state.equity = [];
            state.position = null;
            let capital = state.capital;
            let peakCapital = capital;
            let maxDrawdown = 0;
            
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('backtestBtn').disabled = true;
            
            addLog('system', 'üöÄ BACKTEST', 'D√©but du backtest sur 1 an');
            
            const minPeriod = 200; // Need enough data for EMA 200
            
            for (let i = minPeriod; i < state.data.length; i++) {
                const current = state.data[i];
                const idx = i;
                
                // Update progress
                const progress = ((i - minPeriod) / (state.data.length - minPeriod)) * 100;
                document.getElementById('progressBar').style.width = progress.toFixed(1) + '%';
                document.getElementById('progressPercent').textContent = progress.toFixed(1) + '%';
                document.getElementById('currentDay').textContent = `${i - minPeriod + 1} / ${state.data.length - minPeriod}`;
                document.getElementById('currentDate').textContent = new Date(current.timestamp).toLocaleDateString('fr-FR');
                document.getElementById('currentPrice').textContent = '$' + current.close.toFixed(2);
                document.getElementById('totalTrades').textContent = state.trades.length;
                
                // Check for buy signal
                if (!state.position && shouldBuy(idx)) {
                    const tradeAmount = capital * 0.3;
                    const fees = tradeAmount * 0.001;
                    const slippage = tradeAmount * 0.0005;
                    const totalCost = tradeAmount + fees + slippage;
                    
                    if (totalCost <= capital) {
                        const tokensAmount = tradeAmount / current.close;
                        
                        state.position = {
                            entryPrice: current.close,
                            entryTime: current.timestamp,
                            amount: tradeAmount,
                            tokensAmount: tokensAmount,
                            peak: current.close
                        };
                        
                        capital -= totalCost;
                        
                        addLog('BUY', 'üü¢ ACHAT', `${tokensAmount.toFixed(6)} @ $${current.close.toFixed(2)} ‚Ä¢ Capital: $${capital.toFixed(2)}`);
                    }
                }
                
                // Check for sell signal
                if (state.position && shouldSell(idx, state.position, current)) {
                    const sellValue = state.position.tokensAmount * current.close;
                    const fees = sellValue * 0.001;
                    const slippage = sellValue * 0.0005;
                    const netValue = sellValue - fees - slippage;
                    
                    const profit = netValue - state.position.amount;
                    const profitPercent = (profit / state.position.amount) * 100;
                    
                    capital += netValue;
                    
                    state.trades.push({
                        entry: state.position.entryPrice,
                        exit: current.close,
                        profit: profit,
                        profitPercent: profitPercent,
                        duration: current.timestamp - state.position.entryTime
                    });
                    
                    addLog('SELL', profit >= 0 ? 'üü¢ VENTE' : 'üî¥ VENTE', 
                        `$${netValue.toFixed(2)} ‚Ä¢ P/L: ${profit >= 0 ? '+' : ''}$${profit.toFixed(2)} (${profitPercent >= 0 ? '+' : ''}${profitPercent.toFixed(2)}%)`);
                    
                    state.position = null;
                }
                
                // Update peak for trailing stop
                if (state.position && current.close > state.position.peak) {
                    state.position.peak = current.close;
                }
                
                // Track equity
                let currentEquity = capital;
                if (state.position) {
                    currentEquity += state.position.tokensAmount * current.close;
                }
                state.equity.push({ time: current.timestamp, value: currentEquity });
                
                // Track drawdown
                if (currentEquity > peakCapital) {
                    peakCapital = currentEquity;
                }
                const drawdown = ((peakCapital - currentEquity) / peakCapital) * 100;
                if (drawdown > maxDrawdown) {
                    maxDrawdown = drawdown;
                }
                
                if (i % 10 === 0) await new Promise(r => setTimeout(r, 1));
            }
            
            // Close final position if any
            if (state.position) {
                const lastData = state.data[state.data.length - 1];
                const sellValue = state.position.tokensAmount * lastData.close;
                const fees = sellValue * 0.001;
                const netValue = sellValue - fees;
                const profit = netValue - state.position.amount;
                
                capital += netValue;
                state.trades.push({
                    entry: state.position.entryPrice,
                    exit: lastData.close,
                    profit: profit,
                    profitPercent: (profit / state.position.amount) * 100
                });
                
                addLog('SELL', '‚èπÔ∏è CL√îTURE', `Position finale vendue`);
            }
            
            // Display results
            displayResults(capital, maxDrawdown);
            
            document.getElementById('backtestBtn').disabled = false;
            addLog('system', '‚úÖ TERMIN√â', `Backtest compl√©t√© ‚Ä¢ ${state.trades.length} trades`);
        }

        function shouldBuy(idx) {
            const rsi = state.indicators.rsi[idx];
            const macd = state.indicators.macd.macd[idx];
            const macdSignal = state.indicators.macd.signal[idx];
            const price = state.data[idx].close;
            const ema20 = state.indicators.ema20[idx];
            const ema50 = state.indicators.ema50[idx];
            const stochRSI = state.indicators.stochRSI[idx];
            const bbLower = state.indicators.bb.lower[idx];
            const adx = state.indicators.adx[idx];
            const avgVolume = state.data.slice(Math.max(0, idx - 20), idx).reduce((sum, d) => sum + d.volume, 0) / 20;
            const currentVolume = state.data[idx].volume;
            
            return (
                rsi < 35 &&
                macd > macdSignal &&
                price > ema50 &&
                ema20 > ema50 &&
                stochRSI < 20 &&
                price < bbLower * 1.02 &&
                adx > 20 &&
                currentVolume > avgVolume * 0.8
            );
        }

        function shouldSell(idx, position, current) {
            const profitPercent = ((current.close - position.entryPrice) / position.entryPrice) * 100;
            const trailingStop = ((position.peak - current.close) / position.peak) * 100;
            
            const rsi = state.indicators.rsi[idx];
            const macd = state.indicators.macd.macd[idx];
            const macdSignal = state.indicators.macd.signal[idx];
            const price = current.close;
            const ema50 = state.indicators.ema50[idx];
            
            return (
                profitPercent >= 3 ||
                profitPercent <= -2 ||
                trailingStop >= 1.5 ||
                rsi > 70 ||
                macd < macdSignal ||
                price < ema50
            );
        }

        function displayResults(finalCapital, maxDrawdown) {
            const initialCapital = state.capital;
            const totalProfit = finalCapital - initialCapital;
            const roi = (totalProfit / initialCapital) * 100;
            
            const wins = state.trades.filter(t => t.profit > 0);
            const losses = state.trades.filter(t => t.profit <= 0);
            const winRate = state.trades.length > 0 ? (wins.length / state.trades.length) * 100 : 0;
            
            const avgWin = wins.length > 0 ? wins.reduce((sum, t) => sum + t.profit, 0) / wins.length : 0;
            const avgLoss = losses.length > 0 ? losses.reduce((sum, t) => sum + t.profit, 0) / losses.length : 0;
            const maxWin = wins.length > 0 ? Math.max(...wins.map(t => t.profit)) : 0;
            const maxLoss = losses.length > 0 ? Math.min(...losses.map(t => t.profit)) : 0;
            
            const totalWins = wins.reduce((sum, t) => sum + t.profit, 0);
            const totalLosses = Math.abs(losses.reduce((sum, t) => sum + t.profit, 0));
            const profitFactor = totalLosses > 0 ? totalWins / totalLosses : totalWins > 0 ? 999 : 0;
            
            // Sharpe Ratio (simplified)
            const returns = state.trades.map(t => t.profitPercent);
            const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
            const variance = returns.reduce((a, b) => a + Math.pow(b - avgReturn, 2), 0) / returns.length;
            const stdDev = Math.sqrt(variance);
            const sharpeRatio = stdDev > 0 ? (avgReturn / stdDev) : 0;
            
            // Update UI
            const roiEl = document.getElementById('finalROI');
            roiEl.textContent = (roi >= 0 ? '+' : '') + roi.toFixed(2) + '%';
            roiEl.className = roi >= 0 ? 'text-4xl font-bold text-white' : 'text-4xl font-bold text-red-400';
            
            document.getElementById('initialCapital').textContent = '$' + initialCapital.toFixed(0);
            document.getElementById('finalCapital').textContent = '$' + finalCapital.toFixed(2);
            
            const profitEl = document.getElementById('totalProfit');
            profitEl.textContent = (totalProfit >= 0 ? '+$' : '-$') + Math.abs(totalProfit).toFixed(2);
            profitEl.className = totalProfit >= 0 ? 'text-xl font-bold text-green-400' : 'text-xl font-bold text-red-400';
            
            document.getElementById('numTrades').textContent = state.trades.length;
            document.getElementById('winRate').textContent = winRate.toFixed(1) + '%';
            document.getElementById('winTrades').textContent = wins.length;
            document.getElementById('loseTrades').textContent = losses.length;
            document.getElementById('avgWin').textContent = '+$' + avgWin.toFixed(2);
            document.getElementById('avgLoss').textContent = '$' + avgLoss.toFixed(2);
            document.getElementById('maxWin').textContent = '+$' + maxWin.toFixed(2);
            document.getElementById('maxLoss').textContent = '$' + maxLoss.toFixed(2);
            document.getElementById('profitFactor').textContent = profitFactor.toFixed(2);
            document.getElementById('maxDrawdown').textContent = maxDrawdown.toFixed(2) + '%';
            document.getElementById('sharpeRatio').textContent = sharpeRatio.toFixed(2);
            
            // Show results
            document.getElementById('resultsSection').style.display = 'grid';
            document.getElementById('chartSection').style.display = 'block';
            
            // Update equity chart
            const step = Math.max(1, Math.floor(state.equity.length / 200));
            const filtered = state.equity.filter((_, i) => i % step === 0);
            
            equityChart.data.labels = filtered.map(e => new Date(e.time).toLocaleDateString('fr-FR'));
            equityChart.data.datasets[0].data = filtered.map(e => e.value);
            equityChart.update();
            
            // Analyze indicator performance
            analyzeIndicatorPerformance();
            
            // Update price charts
            updatePriceCharts();
        }

        function analyzeIndicatorPerformance() {
            // Track which indicators were most accurate for buy signals
            let indicatorScores = {
                rsi: { correct: 0, total: 0, name: 'RSI < 35' },
                macd: { correct: 0, total: 0, name: 'MACD Bullish Cross' },
                ema_cross: { correct: 0, total: 0, name: 'EMA 20 > EMA 50' },
                price_ema: { correct: 0, total: 0, name: 'Prix > EMA 50' },
                stochRSI: { correct: 0, total: 0, name: 'Stoch RSI < 20' },
                bb_lower: { correct: 0, total: 0, name: 'BB Lower Band' },
                adx: { correct: 0, total: 0, name: 'ADX > 20' },
                volume: { correct: 0, total: 0, name: 'Volume √©lev√©' }
            };
            
            // Analyze each trade
            state.trades.forEach(trade => {
                const profitable = trade.profit > 0;
                
                // Check each indicator at entry
                const entryIdx = state.data.findIndex(d => d.close === trade.entry);
                if (entryIdx > 0) {
                    // RSI
                    if (state.indicators.rsi[entryIdx] < 35) {
                        indicatorScores.rsi.total++;
                        if (profitable) indicatorScores.rsi.correct++;
                    }
                    
                    // MACD
                    if (state.indicators.macd.macd[entryIdx] > state.indicators.macd.signal[entryIdx]) {
                        indicatorScores.macd.total++;
                        if (profitable) indicatorScores.macd.correct++;
                    }
                    
                    // EMA Cross
                    if (state.indicators.ema20[entryIdx] > state.indicators.ema50[entryIdx]) {
                        indicatorScores.ema_cross.total++;
                        if (profitable) indicatorScores.ema_cross.correct++;
                    }
                    
                    // Prix > EMA 50
                    if (trade.entry > state.indicators.ema50[entryIdx]) {
                        indicatorScores.price_ema.total++;
                        if (profitable) indicatorScores.price_ema.correct++;
                    }
                    
                    // Stoch RSI
                    if (state.indicators.stochRSI[entryIdx] < 20) {
                        indicatorScores.stochRSI.total++;
                        if (profitable) indicatorScores.stochRSI.correct++;
                    }
                    
                    // BB Lower
                    if (trade.entry < state.indicators.bb.lower[entryIdx] * 1.02) {
                        indicatorScores.bb_lower.total++;
                        if (profitable) indicatorScores.bb_lower.correct++;
                    }
                    
                    // ADX
                    if (state.indicators.adx[entryIdx] > 20) {
                        indicatorScores.adx.total++;
                        if (profitable) indicatorScores.adx.correct++;
                    }
                }
            });
            
            // Calculate accuracy for each indicator
            const performance = Object.entries(indicatorScores)
                .map(([key, score]) => ({
                    key,
                    name: score.name,
                    accuracy: score.total > 0 ? (score.correct / score.total) * 100 : 0,
                    total: score.total,
                    correct: score.correct
                }))
                .sort((a, b) => b.accuracy - a.accuracy);
            
            state.indicatorPerformance = performance;
            
            // Display results
            displayIndicatorAnalysis(performance);
        }

        function displayIndicatorAnalysis(performance) {
            // Best indicators
            const best = performance.slice(0, 3);
            const bestHTML = best.map((ind, i) => {
                const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : 'ü•â';
                return `
                    <div class="flex items-center justify-between bg-yellow-800 bg-opacity-30 rounded-lg p-3">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">${medal}</span>
                            <div>
                                <p class="font-bold text-yellow-100">${ind.name}</p>
                                <p class="text-xs text-yellow-300">${ind.correct}/${ind.total} trades r√©ussis</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-yellow-400">${ind.accuracy.toFixed(1)}%</p>
                            <p class="text-xs text-yellow-300">pr√©cision</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('bestIndicators').innerHTML = bestHTML;
            
            // Predictive indicators
            const predictive = performance.filter(p => p.accuracy >= 50 && p.total >= 3);
            const predictiveHTML = predictive.map(ind => `
                <div class="bg-blue-800 bg-opacity-30 rounded-lg p-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-semibold text-blue-200">${ind.name}</span>
                        <span class="text-sm font-bold text-blue-400">${ind.accuracy.toFixed(1)}%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2 mt-2">
                        <div class="bg-blue-500 h-2 rounded-full" style="width: ${ind.accuracy}%"></div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('predictiveIndicators').innerHTML = predictiveHTML || 
                '<p class="text-sm text-gray-400">Pas assez de donn√©es</p>';
            
            // Weak indicators
            const weak = performance.filter(p => p.accuracy < 50 && p.total >= 3);
            const weakHTML = weak.map(ind => `
                <div class="bg-purple-800 bg-opacity-30 rounded-lg p-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-semibold text-purple-200">${ind.name}</span>
                        <span class="text-sm font-bold text-purple-400">${ind.accuracy.toFixed(1)}%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2 mt-2">
                        <div class="bg-purple-500 h-2 rounded-full" style="width: ${ind.accuracy}%"></div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('weakIndicators').innerHTML = weakHTML || 
                '<p class="text-sm text-gray-400">Tous les indicateurs sont performants ‚úÖ</p>';
            
            // Recommendations
            const recommendations = [];
            
            if (best.length > 0 && best[0].accuracy > 70) {
                recommendations.push(`‚úÖ Excellent: "${best[0].name}" est tr√®s fiable (${best[0].accuracy.toFixed(1)}%)`);
            }
            
            if (weak.length > 0) {
                recommendations.push(`‚ö†Ô∏è Attention: "${weak[0].name}" montre une faible pr√©cision (${weak[0].accuracy.toFixed(1)}%)`);
                recommendations.push(`üí° Suggestion: R√©duire le poids de "${weak[0].name}" dans la strat√©gie`);
            }
            
            const avgAccuracy = performance.reduce((sum, p) => sum + p.accuracy, 0) / performance.length;
            if (avgAccuracy < 50) {
                recommendations.push('üìâ Performance globale faible - envisager d\'ajuster les seuils');
            } else if (avgAccuracy > 60) {
                recommendations.push('üìà Bonne performance globale des indicateurs');
            }
            
            if (state.trades.length < 10) {
                recommendations.push('‚ö†Ô∏è Peu de trades - augmenter la p√©riode ou ajuster les crit√®res d\'entr√©e');
            }
            
            const recHTML = recommendations.map(rec => `<li>‚Ä¢ ${rec}</li>`).join('');
            document.getElementById('recommendations').innerHTML = `<ul class="space-y-1">${recHTML}</ul>`;
            
            // Show section
            document.getElementById('indicatorsAnalysis').style.display = 'block';
        }

        function updatePriceCharts() {
            // Update price chart
            const step = Math.max(1, Math.floor(state.data.length / 200));
            const filtered = state.data.filter((_, i) => i % step === 0);
            
            priceChart.data.labels = filtered.map(d => new Date(d.timestamp).toLocaleDateString('fr-FR'));
            priceChart.data.datasets[0].data = filtered.map(d => d.close);
            priceChart.update();
            
            // Update RSI chart
            rsiChart.data.labels = filtered.map(d => new Date(d.timestamp).toLocaleDateString('fr-FR'));
            rsiChart.data.datasets[0].data = filtered.map((d, i) => state.indicators.rsi[i * step]);
            rsiChart.update();
            
            // Update MACD chart
            macdChart.data.labels = filtered.map(d => new Date(d.timestamp).toLocaleDateString('fr-FR'));
            macdChart.data.datasets[0].data = filtered.map((d, i) => state.indicators.macd.histogram[i * step]);
            macdChart.data.datasets[1].data = filtered.map((d, i) => state.indicators.macd.macd[i * step]);
            macdChart.data.datasets[2].data = filtered.map((d, i) => state.indicators.macd.signal[i * step]);
            macdChart.update();
            
            // Show sections
            document.getElementById('priceChartSection').style.display = 'block';
            document.getElementById('rsiChartSection').style.display = 'block';
        }

        function toggleIndicator(type) {
            chartVisibility[type] = !chartVisibility[type];
            
            if (type === 'ema') {
                if (chartVisibility.ema) {
                    // Add EMA 20 and 50
                    const step = Math.max(1, Math.floor(state.data.length / 200));
                    const filtered = state.data.filter((_, i) => i % step === 0);
                    
                    priceChart.data.datasets.push({
                        label: 'EMA 20',
                        data: filtered.map((d, i) => state.indicators.ema20[i * step]),
                        borderColor: '#f59e0b',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: false,
                        pointRadius: 0
                    });
                    
                    priceChart.data.datasets.push({
                        label: 'EMA 50',
                        data: filtered.map((d, i) => state.indicators.ema50[i * step]),
                        borderColor: '#ef4444',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: false,
                        pointRadius: 0
                    });
                } else {
                    // Remove EMA datasets
                    priceChart.data.datasets = priceChart.data.datasets.filter(d => !d.label.includes('EMA'));
                }
            } else if (type === 'bb') {
                if (chartVisibility.bb) {
                    // Add Bollinger Bands
                    const step = Math.max(1, Math.floor(state.data.length / 200));
                    const filtered = state.data.filter((_, i) => i % step === 0);
                    
                    priceChart.data.datasets.push({
                        label: 'BB Upper',
                        data: filtered.map((d, i) => state.indicators.bb.upper[i * step]),
                        borderColor: '#a855f7',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        tension: 0.4,
                        fill: false,
                        pointRadius: 0
                    });
                    
                    priceChart.data.datasets.push({
                        label: 'BB Lower',
                        data: filtered.map((d, i) => state.indicators.bb.lower[i * step]),
                        borderColor: '#a855f7',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        tension: 0.4,
                        fill: false,
                        pointRadius: 0
                    });
                } else {
                    priceChart.data.datasets = priceChart.data.datasets.filter(d => !d.label.includes('BB'));
                }
            } else if (type === 'trades') {
                if (chartVisibility.trades) {
                    // Add buy/sell markers
                    const step = Math.max(1, Math.floor(state.data.length / 200));
                    const buyPoints = state.trades.map(t => {
                        const idx = state.data.findIndex(d => d.close === t.entry);
                        return { x: Math.floor(idx / step), y: t.entry };
                    }).filter(p => p.x >= 0);
                    
                    const sellPoints = state.trades.map(t => {
                        const idx = state.data.findIndex(d => d.close === t.exit);
                        return { x: Math.floor(idx / step), y: t.exit };
                    }).filter(p => p.x >= 0);
                    
                    priceChart.data.datasets.push({
                        label: 'Achats',
                        data: buyPoints,
                        borderColor: '#10b981',
                        backgroundColor: '#10b981',
                        pointRadius: 6,
                        pointStyle: 'triangle',
                        showLine: false
                    });
                    
                    priceChart.data.datasets.push({
                        label: 'Ventes',
                        data: sellPoints,
                        borderColor: '#ef4444',
                        backgroundColor: '#ef4444',
                        pointRadius: 6,
                        pointStyle: 'triangle',
                        rotation: 180,
                        showLine: false
                    });
                } else {
                    priceChart.data.datasets = priceChart.data.datasets.filter(d => 
                        d.label !== 'Achats' && d.label !== 'Ventes'
                    );
                }
            }
            
            priceChart.update();
        }

        function resetChart() {
            chartVisibility = { ema: false, bb: false, trades: false };
            
            const step = Math.max(1, Math.floor(state.data.length / 200));
            const filtered = state.data.filter((_, i) => i % step === 0);
            
            priceChart.data.datasets = [{
                label: 'Prix',
                data: filtered.map(d => d.close),
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 2,
                tension: 0.1,
                fill: false,
                pointRadius: 0
            }];
            
            priceChart.update();
        }

        function addLog(source, action, details) {
            const timestamp = new Date().toLocaleTimeString();
            state.logs.unshift({ timestamp, source, action, details });
            if (state.logs.length > 100) state.logs.pop();
            
            if (state.logs.length % 5 === 0 || action.includes('‚úÖ') || action.includes('‚ùå')) {
                renderLogs();
            }
        }

        function renderLogs() {
            const icons = { 
                BUY: 'üü¢',
                SELL: 'üî¥',
                system: '‚öôÔ∏è'
            };
            
            const display = state.logs.slice(0, 50);
            
            const html = display.map(log => `
                <div class="bg-gray-800 bg-opacity-50 border border-gray-700 rounded-lg p-3">
                    <div class="flex items-start gap-3">
                        <span class="text-2xl">${icons[log.source] || 'üìä'}</span>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-white">${log.source}</span>
                                <span class="text-xs text-gray-500">${log.timestamp}</span>
                            </div>
                            <p class="text-sm font-semibold mb-1 text-gray-300">${log.action}</p>
                            <p class="text-xs text-gray-400">${log.details}</p>
                        </div>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('tradeLogs').innerHTML = html || 
                '<div class="text-center text-gray-500 py-8">Aucun trade</div>';
        }

        function clearLogs() {
            if (confirm('Effacer les logs ?')) {
                state.logs = [];
                renderLogs();
            }
        }

        console.log('ü§ñ Trading Bot PRO - Initialized');
    </script>
</body>
</html>
